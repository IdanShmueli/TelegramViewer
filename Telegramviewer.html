<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Chat Viewer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ======= 住转 住住 ======= */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background-color: #f2f2f2;
            direction: rtl;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ======= 住专  ======= */
        .toolbar {
            background-color: #5682a3;
            padding: 15px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 12px;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .toolbar button {
            background-color: #6e9cc6;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .toolbar button:hover {
            background-color: #4e7ca3;
        }

        .toolbar input[type="file"] {
            display: none;
        }

        /* =======  砖 ======= */
        .container {
            flex: 1;
            display: flex;
            justify-content: center;
            padding: 20px;
            overflow: auto;
        }

        #chat-container {
            width: 100%;
            max-width: 650px;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* ======= 转专转 砖 ======= */
        .chat-header {
            background-color: #5682a3;
            color: white;
            padding: 15px;
            display: flex;
            align-items: center;
        }

        .avatar {
            width: 45px;
            height: 45px;
            background-color: #6e9cc6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
            color: white;
            font-weight: bold;
            font-size: 20px;
            overflow: hidden;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chat-info h2 {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .chat-info p {
            font-size: 13px;
            opacity: 0.8;
        }

        /* ======= 祝 砖 ======= */
        .chat-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #e6ebee;
            position: relative;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* 专拽注 砖拽祝 祝 砖 砖专 砖 转转 专拽注 */
        .chat-body.has-background::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(230, 235, 238, 0.85);
            z-index: 0;
        }

        /* =======  注转 ======= */
        .no-chat {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #555;
            padding: 20px;
            text-align: center;
        }

        .no-chat i {
            font-size: 60px;
            color: #5682a3;
            margin-bottom: 20px;
        }

        .no-chat p {
            font-size: 16px;
            margin-bottom: 10px;
        }

        /* ======= 转专转 转专 ======= */
        .date-header {
            text-align: center;
            margin: 15px 0;
            position: relative;
            z-index: 1;
        }

        .date-header span {
            background-color: rgba(225, 245, 254, 0.92);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            color: #505050;
            box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
        }

        /* ======= 注转 ======= */
        .message {
            display: flex;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .message.out {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 65%;
            padding: 8px 10px;
            border-radius: 8px;
            position: relative;
            word-wrap: break-word;
            line-height: 1.4;
            font-size: 14px;
            box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
        }

        .out .message-bubble {
            background-color: #eeffde;
            margin-left: 50px;
        }

        .in .message-bubble {
            background-color: white;
            margin-right: 50px;
        }

        .sender {
            font-size: 12.5px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .message-content {
            margin-bottom: 4px;
        }

        .message-time {
            font-size: 11px;
            color: rgba(0, 0, 0, 0.45);
            text-align: left;
            float: right;
            margin-top: 2px;
        }

        /* ======= 拽爪 爪专驻 ======= */
        .attachment {
            margin-bottom: 5px;
        }

        .attachment img, .sticker img {
            max-width: 100%;
            border-radius: 6px;
            cursor: pointer;
        }

        .attachment-image {
            cursor: pointer;
            transition: transform 0.2s;
        }

        .attachment-image:hover {
            transform: scale(1.02);
        }

        .sticker {
            margin-bottom: 5px;
        }

        .sticker img {
            max-width: 150px;
            max-height: 150px;
            cursor: pointer;
        }

        .attachment-file {
            display: flex;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.05);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 5px;
        }

        .attachment-file i {
            font-size: 24px;
            margin-left: 10px;
            color: #8696a0;
        }

        .attachment-file span {
            font-size: 13px;
        }

        .audio-attachment {
            margin-bottom: 5px;
        }

        .audio-attachment audio {
            width: 100%;
            height: 36px;
        }

        /* =======  转 ======= */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }

        /* ======= 转爪专转 注 转拽转 ======= */
        .loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
        }

        .loader i {
            font-size: 40px;
            margin-bottom: 10px;
        }

        /* ======= 注转 住住 ======= */
        #status {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 3000;
            display: none;
        }

        #status.success {
            background-color: #28a745;
        }

        #status.error {
            background-color: #dc3545;
        }

        /* 转 驻注转 转 砖 注 专拽注 */
        #messages-container {
            position: relative;
            z-index: 1;
        }

        /* ======= 专转 砖转 注专 转驻专 砖 转转 驻专驻 专拽注 ======= */
        .settings-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .settings-container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .settings-title {
            font-size: 18px;
            font-weight: 500;
        }

        .settings-close {
            font-size: 24px;
            cursor: pointer;
            color: #555;
        }

        .settings-section {
            margin-bottom: 15px;
        }

        .settings-section h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #5682a3;
        }

        .settings-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .settings-preview {
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #6e9cc6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 36px;
            overflow: hidden;
        }

        .profile-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .background-preview {
            width: 200px;
            height: 150px;
            border-radius: 8px;
            border: 2px dashed #ddd;
            background-color: #f9f9f9;
            background-size: cover;
            background-position: center;
            margin-top: 10px;
        }

        .file-input-wrapper {
            margin-top: 10px;
        }

        .custom-file-input {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            display: inline-block;
            font-size: 14px;
        }

        .custom-file-input:hover {
            background-color: #e5e5e5;
        }

        /* 住 驻转专 住专转 转 */
        .remove-image-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            margin-right: 10px;
            font-size: 12px;
            cursor: pointer;
        }

        .remove-image-btn:hover {
            background-color: #c82333;
        }

        /* ======= 住转 砖 爪转 注专转 砖 注转 ======= */
        .message-note {
            font-size: 11px;
            font-style: italic;
            color: #777;
            margin-top: 2px;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
        }

        .message-note i {
            margin-left: 4px;
            font-size: 10px;
        }

        .message-edited {
            color: #007bff;
        }

        .message-deleted {
            color: #dc3545;
        }

        .message-forwarded {
            color: #6c757d;
        }

        /* ======= 住转 砖  砖转转驻 ======= */
        .participants-section {
            margin-bottom: 20px;
            max-height: 250px;
            overflow-y: auto;
        }

        .participant-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .participant-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #6e9cc6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-left: 10px;
            overflow: hidden;
        }

        .participant-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .participant-info {
            flex: 1;
        }

        .participant-name {
            font-weight: 500;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
        }

        .participant-color-preview {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            border: 1px solid #ddd;
        }

        .participant-actions {
            display: flex;
            align-items: center;
        }

        .color-picker-container {
            display: flex;
            align-items: center;
            margin-top: 5px;
        }

        .color-picker-label {
            font-size: 12px;
            margin-left: 8px;
        }

        input[type="color"] {
            width: 25px;
            height: 25px;
            border: none;
            cursor: pointer;
        }

        .participant-upload {
            background-color: #f0f0f0;
            border: none;
            padding: 5px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }

        .participant-upload:hover {
            background-color: #e0e0e0;
        }

        .no-participants {
            text-align: center;
            padding: 20px;
            color: #777;
            font-style: italic;
        }

        /* ======= 住转  专 ======= */
        .service-message {
            text-align: center;
            margin: 10px 0;
            position: relative;
            z-index: 1;
        }

        .service-message span {
            background-color: rgba(204, 224, 245, 0.92);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            color: #505050;
            box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13);
        }

        .sticker {
            max-width: 150px;
            max-height: 150px;
            border-radius: 0;
        }

        .reply-to {
            margin-bottom: 5px;
            padding: 5px 8px;
            border-right: 3px solid #5682a3;
            background-color: rgba(86, 130, 163, 0.1);
            border-radius: 4px;
            font-size: 12px;
            color: #666;
        }

        .reply-to .reply-sender {
            font-weight: bold;
            color: #5682a3;
        }

        .reply-to .reply-content {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .message-views {
            margin-right: 8px;
            font-size: 11px;
            color: rgba(0, 0, 0, 0.45);
        }

        .message-reactions {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }

        .reaction {
            display: inline-flex;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.05);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 12px;
        }

        .reaction .emoji {
            margin-left: 3px;
        }

        .reaction .count {
            font-size: 11px;
            color: #666;
        }

        .poll-container {
            margin-top: 5px;
        }

        .poll-question {
            font-weight: bold;
            margin-bottom: 8px;
        }

        .poll-option {
            display: flex;
            margin-bottom: 4px;
        }

        .poll-option-text {
            flex: 1;
        }

        .poll-option-votes {
            font-size: 12px;
            color: #666;
            margin-right: 5px;
        }

        .poll-option-bar {
            height: 4px;
            background-color: #ddd;
            margin-top: 4px;
            position: relative;
        }

        .poll-option-progress {
            height: 100%;
            background-color: #5682a3;
            position: absolute;
            top: 0;
            right: 0;
        }

        .location-preview {
            width: 100%;
            height: 150px;
            background-color: #f0f0f0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
        }

        .location-preview i {
            font-size: 24px;
            color: #5682a3;
            margin-left: 10px;
        }

        .video-note {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .video-note video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .voice-message {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .voice-message i {
            font-size: 18px;
            color: #5682a3;
            margin-left: 10px;
        }

        .voice-message audio {
            flex: 1;
            height: 32px;
        }

        .voice-message-duration {
            font-size: 12px;
            color: #666;
            margin-right: 10px;
        }

        /* 住 转转 (专拽爪转) 砖 专 */
        .reactions {
            margin-top: 5px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .reaction {
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 12px;
            background-color: #e8f5fc;
            color: #5682a3;
        }

        .reaction .emoji {
            margin-left: 3px;
        }

        .reaction .count {
            font-size: 11px;
            margin-right: 3px;
        }

        /* 住专转 住专 */
        .video-container {
            position: relative;
            margin-bottom: 5px;
            border-radius: 6px;
            overflow: hidden;
        }

        .video-container video {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
        }

        .video-duration {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 11px;
        }

        /* 住 拽抓 爪专祝 */
        .document-container {
            display: flex;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.05);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 5px;
        }

        .document-icon {
            font-size: 24px;
            margin-left: 10px;
            color: #5682a3;
        }

        .document-info {
            flex: 1;
        }

        .document-title {
            font-weight: bold;
            margin-bottom: 2px;
        }

        .document-size {
            font-size: 11px;
            color: #666;
        }

        /* 住 转爪 砖 拽爪 HEIC */
        .heic-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        /* 注爪 转转 注专转 砖  */
        .video-thumbnail {
            position: relative;
            max-width: 100%;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .video-play-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 42px;
            color: white;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .video-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            text-align: center;
        }

        /* 注爪 住拽专 驻砖 */
        .sticker-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #f0f0f0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 5px;
        }

        .sticker-emoji {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .sticker-info {
            font-size: 12px;
            color: #666;
        }

        /* 转 住拽专 驻砖 */
        .lottie-container {
            width: 150px;
            height: 150px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sticker-animation {
            width: 150px;
            height: 150px;
            margin: 0 auto;
            margin-bottom: 5px;
        }

        /* 注爪 砖 拽砖专 */
        .contact-preview {
            margin-bottom: 5px;
        }

        .contact-info {
            display: flex;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.05);
            padding: 10px;
            border-radius: 8px;
        }

        .contact-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #5682a3;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-left: 12px;
        }

        .contact-details {
            flex: 1;
        }

        .contact-name {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .contact-phone {
            font-size: 13px;
            color: #666;
            direction: ltr;
            text-align: right;
        }

        /* 注爪 拽 */
        .location-box {
            display: flex;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.05);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 5px;
        }

        .location-box i {
            font-size: 24px;
            color: #e74c3c;
            margin-left: 15px;
        }

        .location-info {
            flex: 1;
        }

        .location-coordinates {
            direction: ltr;
            font-family: monospace;
            margin: 5px 0;
        }

        .location-link {
            display: inline-block;
            padding: 5px 10px;
            background-color: #5682a3;
            color: white;
            border-radius: 4px;
            text-decoration: none;
            margin-top: 5px;
            font-size: 12px;
        }

        .location-link:hover {
            background-color: #4a7295;
        }

        /* 注爪 注转  注转 */
        .video-note-thumbnail {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            overflow: hidden;
            margin-bottom: 5px;
            position: relative;
        }

        /* 注爪 转爪 拽 */
        .preview-note {
            font-size: 11px;
            color: #666;
            font-style: italic;
            margin-top: 5px;
            text-align: center;
        }

        /* 住转 驻砖专转 专 */
        .download-link {
            display: inline-block;
            padding: 5px 10px;
            margin-top: 8px;
            background-color: #5682a3;
            color: white;
            border-radius: 4px;
            text-decoration: none;
            font-size: 12px;
            transition: background-color 0.2s;
        }

        .download-link:hover {
            background-color: #4a7295;
            text-decoration: none;
            color: white;
        }

        .download-link i {
            margin-left: 5px;
        }

        /* 注爪 拽爪 专 */
        .file-download-container {
            display: flex;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.05);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 5px;
        }

        .file-icon {
            font-size: 24px;
            margin-left: 15px;
            color: #5682a3;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .file-size {
            font-size: 12px;
            color: #666;
        }

        .download-button {
            background-color: #5682a3;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .download-button:hover {
            background-color: #4a7295;
            color: white;
        }

        /* 住转 转爪转 HEIC */
        .heic-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 5px;
        }

        /*  注 */
        .loading-media {
            padding: 20px;
            text-align: center;
            background-color: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 5px;
            color: #666;
            font-style: italic;
        }

        /*  */
        .video-download {
            text-align: center;
            margin-top: 8px;
        }

        /* 注 转 Data URL 专 拽住 */
        .data-url {
            display: none;
        }

        /* 住转 砖 转 拽爪   */
        .video-fallback {
            background-color: #f0f0f0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            margin-bottom: 5px;
        }

        .video-fallback-icon {
            font-size: 36px;
            color: #5682a3;
            margin-bottom: 10px;
        }

        .video-player {
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        /* 转 住拽专 驻砖 */
        .sticker-animation-container {
            width: 150px;
            height: 150px;
            margin: 0 auto;
            margin-bottom: 5px;
            position: relative;
        }

        /* 注爪 驻转专 驻注 砖 住拽专 驻砖 */
        .sticker-play-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(86, 130, 163, 0.7);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            z-index: 5;
        }

        .sticker-thumbnail {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <!-- 住专  -->
    <div class="toolbar">
        <input type="file" id="zip-file" accept=".zip">
        <button id="upload-zip-btn">
            <i class="fas fa-file-zipper"></i>
            注转 ZIP 
        </button>
        
        <input type="file" id="json-file" accept=".json">
        <button id="upload-json-btn">
            <i class="fas fa-file-code"></i>
            注转 JSON 
        </button>
        
        <button id="settings-btn">
            <i class="fas fa-cog"></i>
            专转 专
        </button>
        
        <button id="participants-btn">
            <i class="fas fa-users"></i>
            砖转转驻
        </button>
        
        <button id="export-html-btn">
            <i class="fas fa-file-code"></i>
            爪 -HTML
        </button>
        
        <button id="clear-btn">
            <i class="fas fa-trash"></i>
            拽 
        </button>
    </div>

    <!--  砖 -->
    <div class="container">
        <div id="chat-container">
            <div class="no-chat">
                <i class="fas fa-paper-plane"></i>
                <p> 砖 爪</p>
                <p>注 拽抓 ZIP 砖 砖转 专  转</p>
            </div>
        </div>
    </div>

    <!--  转转 -->
    <div id="image-modal" class="modal">
        <span class="modal-close">&times;</span>
        <img class="modal-content" id="modal-image">
    </div>

    <!-- 住 注 -->
    <div id="loader" class="loader">
        <i class="fas fa-spinner fa-spin"></i>
        <div id="loader-text">注...</div>
    </div>

    <!-- 注转 住住 -->
    <div id="status"></div>

    <!-- 驻 专转 -->
    <div id="settings-panel" class="settings-panel">
        <div class="settings-container">
            <div class="settings-header">
                <div class="settings-title">专转 专</div>
                <div class="settings-close">&times;</div>
            </div>
            <div class="settings-section">
                <h3>转转 驻专驻</h3>
                <div class="settings-preview">
                    <div class="profile-preview" id="profile-preview">
                        <span id="profile-initial"></span>
                    </div>
                </div>
                <div class="file-input-wrapper">
                    <label class="custom-file-input">
                        专 转
                        <input type="file" id="profile-image-input" accept="image/*" style="display: none;">
                    </label>
                    <button id="remove-profile-image" class="remove-image-btn" style="display: none;">
                        <i class="fas fa-trash"></i> 住专 转
                    </button>
                </div>
            </div>
            <div class="settings-section">
                <h3>转转 专拽注 砖</h3>
                <div class="background-preview" id="background-preview"></div>
                <div class="file-input-wrapper">
                    <label class="custom-file-input">
                        专 转转 专拽注
                        <input type="file" id="background-image-input" accept="image/*" style="display: none;">
                    </label>
                    <button id="remove-background-image" class="remove-image-btn" style="display: none;">
                        <i class="fas fa-trash"></i> 住专 专拽注
                    </button>
                </div>
            </div>
            <div class="settings-actions">
                <button id="close-settings" class="toolbar-button">住专</button>
            </div>
        </div>
    </div>

    <!-- 驻 砖转转驻 -->
    <div id="participants-panel" class="settings-panel">
        <div class="settings-container">
            <div class="settings-header">
                <div class="settings-title"> 砖转转驻</div>
                <div class="settings-close participants-close">&times;</div>
            </div>
            <div class="participants-section" id="participants-list">
                <div class="no-participants">
                    <p> 砖转转驻 爪. 注 拽抓 砖 转.</p>
                </div>
            </div>
            <div class="settings-actions">
                <button id="close-participants" class="toolbar-button">住专</button>
            </div>
        </div>
    </div>

    <!-- 住驻专转 爪转 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script>
        // ===================================================
        // =============== 拽  ===============
        // ===================================================

        // 专 拽爪 
        const mediaStore = new Map();
        
        // 转 砖
        let chatData = {
            name: '',
            type: '', // 'private', 'group'  'channel'
            messages: [],
            about: ''
        };

        // 注 注 转转 驻专驻 专拽注
        let appSettings = {
            profileImage: null,
            backgroundImage: null
        };

        // 注 注 砖转转驻
        let participants = new Map();

        // 注 注 砖转砖 
        let currentUser = {
            id: null,
            name: '',
            username: ''
        };

        // ===================================================
        // ============== 驻 专注 爪转 ==============
        // ===================================================
        
        // 专注 驻转专
        document.getElementById('upload-json-btn').addEventListener('click', () => {
            document.getElementById('json-file').click();
        });
        
        document.getElementById('upload-zip-btn').addEventListener('click', () => {
            document.getElementById('zip-file').click();
        });
        
        document.getElementById('settings-btn').addEventListener('click', () => {
            openSettingsPanel();
        });
        
        document.getElementById('participants-btn').addEventListener('click', () => {
            openParticipantsPanel();
        });
        
        document.getElementById('export-html-btn').addEventListener('click', () => {
            exportChat('html');
        });
        
        document.getElementById('clear-btn').addEventListener('click', clearAll);
        
        // 专注 拽抓
        document.getElementById('json-file').addEventListener('change', handleJsonFile);
        document.getElementById('zip-file').addEventListener('change', handleZipFile);
        
        // 专注 专转
        document.getElementById('profile-image-input').addEventListener('change', handleProfileImageUpload);
        document.getElementById('background-image-input').addEventListener('change', handleBackgroundImageUpload);
        document.getElementById('remove-profile-image').addEventListener('click', removeProfileImage);
        document.getElementById('remove-background-image').addEventListener('click', removeBackgroundImage);
        document.querySelector('.settings-close').addEventListener('click', closeSettingsPanel);
        document.getElementById('close-settings').addEventListener('click', closeSettingsPanel);
        
        // 专注 驻 砖转转驻
        document.querySelector('.participants-close').addEventListener('click', closeParticipantsPanel);
        document.getElementById('close-participants').addEventListener('click', closeParticipantsPanel);
        
        // 住专转  转
        document.querySelector('.modal-close').addEventListener('click', closeModal);
        
        // 住专转  爪 注 Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
                closeSettingsPanel();
                closeParticipantsPanel();
            }
        });

        // ===================================================
        // ============== 驻 拽爪 爪 =============
        // ===================================================
        
        // 驻拽爪 住驻转 住驻专转 专砖转
        function loadExternalLibraries() {
            return new Promise((resolve) => {
                let loadCount = 0;
                const requiredLibs = 2; // 住驻专 住驻专转 砖爪专 注

                // 注 转 住驻专转 Lottie 爪转 住拽专 住 TGS
                if (!window.lottie) {
                    const lottieScript = document.createElement('script');
                    lottieScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.9.6/lottie.min.js';
                    lottieScript.onload = () => {
                        console.log('住驻专转 Lottie 注 爪');
                        loadCount++;
                        if (loadCount === requiredLibs) resolve();
                    };
                    document.head.appendChild(lottieScript);
                } else {
                    loadCount++;
                }

                // 注 转 住驻专转 pako 驻转转 拽爪 住 (专砖 住拽专 TGS)
                if (!window.pako) {
                    const pakoScript = document.createElement('script');
                    pakoScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js';
                    pakoScript.onload = () => {
                        console.log('住驻专转 Pako 注 爪');
                        loadCount++;
                        if (loadCount === requiredLibs) resolve();
                    };
                    document.head.appendChild(pakoScript);
                } else {
                    loadCount++;
                }

                //   住驻专转 专 注
                if (loadCount === requiredLibs) {
                    resolve();
                }
            });
        }

        // 驻拽爪 爪专转 驻专 专 转 拽抓 
        function createDownloadableFile(mediaFile, fileName) {
            if (!mediaFile || !mediaFile.data) return null;
            
            // 爪专转  
            const uniqueId = 'download_' + Math.random().toString(36).substr(2, 9);
            
            // 爪专转 
            let blob;
            if (typeof mediaFile.data === 'string' && mediaFile.data.startsWith('data:')) {
                // 专转 data URL 
                const arr = mediaFile.data.split(',');
                const mime = arr[0].match(/:(.*?);/)[1];
                const bstr = atob(arr[1]);
                let n = bstr.length;
                const u8arr = new Uint8Array(n);
                while (n--) {
                    u8arr[n] = bstr.charCodeAt(n);
                }
                blob = new Blob([u8arr], { type: mime });
            } else if (mediaFile.data instanceof Blob) {
                //   专 , 砖转砖  砖专转
                blob = mediaFile.data;
            } else {
                //    驻专 专, 住 专 
                try {
                    blob = new Blob([mediaFile.data], { type: mediaFile.type || 'application/octet-stream' });
                } catch (e) {
                    console.error('砖 爪专转  :', e);
                    return null;
                }
            }
            
            // 爪专转 URL 
            const url = URL.createObjectURL(blob);
            
            // 砖专转 拽砖专 专 拽 专 转专
            if (!window.downloadLinks) window.downloadLinks = {};
            window.downloadLinks[uniqueId] = url;
            
            return {
                id: uniqueId,
                url: url,
                fileName: fileName || mediaFile.name || 'file',
                size: blob.size,
                type: mediaFile.type || blob.type
            };
        }

        // 驻拽爪 拽 拽砖专 专
        function cleanupDownloadLinks() {
            if (window.downloadLinks) {
                Object.values(window.downloadLinks).forEach(url => {
                    URL.revokeObjectURL(url);
                });
                window.downloadLinks = {};
            }
        }

        // 驻拽爪 砖住 专 拽抓 TGS 爪 砖 Lottie
        async function renderTgsSticker(mediaFile, containerId) {
            if (!mediaFile || !mediaFile.data) return false;
            
            const container = document.getElementById(containerId);
            if (!container) return false;
            
            try {
                //  砖住驻专转 专砖转 注
                await loadExternalLibraries();
                
                if (!window.lottie || !window.pako) {
                    throw new Error("住驻专转 专砖转  注");
                }
                
                // 爪专 拽抓  专
                const downloadInfo = createDownloadableFile(mediaFile, mediaFile.name || 'sticker.tgs');
                
                // 爪专转   爪
                const animationId = 'lottie_' + Math.random().toString(36).substr(2, 9);
                
                // 住祝  爪
                container.innerHTML = `
                    <div class="sticker-animation-container">
                        <div id="${animationId}" class="lottie-container"></div>
                        <div class="sticker-play-button">
                            <i class="fas fa-play"></i>
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <a href="${downloadInfo.url}" download="${downloadInfo.fileName}" class="download-link">
                            <i class="fas fa-download"></i> 专 转 住拽专
                        </a>
                    </div>
                `;
                
                // 注 注 住拽专
                let tgsData;
                
                // 专 转 转 志ArrayBuffer
                if (typeof mediaFile.data === 'string' && mediaFile.data.startsWith('data:')) {
                    // 专 data URL 志ArrayBuffer
                    const base64 = mediaFile.data.split(',')[1];
                    const binaryString = atob(base64);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    tgsData = bytes.buffer;
                } else if (mediaFile.data instanceof ArrayBuffer) {
                    tgsData = mediaFile.data;
                } else {
                    throw new Error("驻专 转 砖 住拽专  转");
                }
                
                // 住 驻转 转 拽抓 志TGS (砖 注爪 拽抓 JSON 住 驻专 gzip)
                const inflatedData = window.pako.inflate(new Uint8Array(tgsData), { to: 'string' });
                const lottieData = JSON.parse(inflatedData);
                
                // 驻转专 驻注
                const playButton = container.querySelector('.sticker-play-button');
                
                // 驻注 转 爪 爪
                playButton.addEventListener('click', function() {
                    // 住专 转 驻转专 驻注
                    playButton.style.display = 'none';
                    
                    // 驻注 转 爪
                    const animation = window.lottie.loadAnimation({
                        container: document.getElementById(animationId),
                        renderer: 'svg',
                        loop: true,
                        autoplay: true,
                        animationData: lottieData
                    });
                });
                
                return true;
            } catch (error) {
                console.error('砖 爪转 住拽专 TGS:', error);
                
                // 爪 转 注专转  砖, 专转 爪 拽
                const thumbnailData = mediaFile.thumbnail_data || 
                    (mediaFile.thumbnail && mediaStore.has(mediaFile.thumbnail) ? 
                        mediaStore.get(mediaFile.thumbnail).data : null);
                
                // 爪专 拽抓  专
                const downloadInfo = createDownloadableFile(mediaFile, mediaFile.name || 'sticker.tgs');
                
                container.innerHTML = `
                    <div class="sticker-placeholder">
                        ${thumbnailData ? 
                            `<img src="${thumbnailData}" alt="转 注专转 砖 住拽专" class="sticker-thumbnail">` : 
                            `<span class="sticker-emoji"></span>`
                        }
                        <div class="sticker-info">住拽专 驻砖</div>
                        <a href="${downloadInfo.url}" download="${downloadInfo.fileName}" class="download-link">
                            <i class="fas fa-download"></i> 专 转 住拽专
                        </a>
                    </div>
                `;
                return false;
            }
        }

        // 驻拽爪 砖驻专转 驻 拽抓 MOV
        function handleMovVideo(mediaFile, containerId) {
            if (!mediaFile || !mediaFile.data) return false;
            
            try {
                const container = document.getElementById(containerId);
                if (!container) return false;
                
                // 爪专 拽抓  专
                const downloadInfo = createDownloadableFile(mediaFile, mediaFile.name || 'video.mov');
                
                // 拽  砖 转 注专转
                const thumbnailData = mediaFile.thumbnail_data || 
                    (mediaFile.thumbnail && mediaStore.has(mediaFile.thumbnail) ? 
                        mediaStore.get(mediaFile.thumbnail).data : null);
                
                // 住 专 转  -MP4 ( 转 驻砖专 驻驻)
                //  拽 爪 转  驻 砖 注 住驻专 驻专 驻砖专
                container.innerHTML = `
                    <div class="video-player">
                        <video controls width="100%" poster="${thumbnailData || ''}">
                            <source src="${downloadInfo.url}" type="video/quicktime">
                            <source src="${downloadInfo.url}" type="video/mp4">
                            <source src="${downloadInfo.url}" type="video/x-m4v">
                            <div class="video-fallback">
                                <div class="video-fallback-icon">
                                    <i class="fas fa-video"></i>
                                </div>
                                <p>驻驻   爪 转 住专</p>
                            </div>
                        </video>
                    </div>
                    <div class="video-download" style="text-align: center;">
                        <a href="${downloadInfo.url}" download="${downloadInfo.fileName}" class="download-link">
                            <i class="fas fa-download"></i> 专 转 住专
                        </a>
                    </div>
                `;
                
                // 拽   注 爪
                const videoElement = container.querySelector('video');
                
                videoElement.addEventListener('error', () => {
                    //  砖 砖, 爪 转 注专转 注 拽砖专 专
                    if (thumbnailData) {
                        container.innerHTML = `
                            <div class="video-thumbnail">
                                <img src="${thumbnailData}" alt="转 注专转 砖 住专" class="attachment-image">
                                <div class="video-play-icon"><i class="fas fa-play-circle"></i></div>
                            </div>
                            <div class="video-info">
                                <p> 转 爪 转 住专 驻驻</p>
                                <a href="${downloadInfo.url}" download="${downloadInfo.fileName}" class="download-link">
                                    <i class="fas fa-download"></i> 专 转 住专
                                </a>
                            </div>
                        `;
                    } else {
                        //   转 注专转, 爪 专拽 拽 拽砖专 专
                        container.innerHTML = `
                            <div class="video-fallback">
                                <div class="video-fallback-icon">
                                    <i class="fas fa-video"></i>
                                </div>
                                <p> 转 爪 转 住专 驻驻</p>
                                <a href="${downloadInfo.url}" download="${downloadInfo.fileName}" class="download-link">
                                    <i class="fas fa-download"></i> 专 转 住专
                                </a>
                            </div>
                        `;
                    }
                });
                
                return true;
            } catch (error) {
                console.error('砖 驻 拽抓 MOV:', error);
                return false;
            }
        }

        // 驻拽爪 砖驻专转 驻  拽抓 
        function handleGenericFile(mediaFile, containerId) {
            if (!mediaFile || !mediaFile.data) return false;
            
            try {
                const container = document.getElementById(containerId);
                if (!container) return false;
                
                // 爪专 拽抓  专
                const downloadInfo = createDownloadableFile(mediaFile, mediaFile.name);
                if (!downloadInfo) {
                    throw new Error(" 转 爪专 拽砖专 专");
                }
                
                // 拽 转 住 拽抓
                const fileIcon = getFileIcon(mediaFile.name, mediaFile.type);
                const fileSize = formatFileSize(downloadInfo.size);
                const fileExt = getFileExtension(mediaFile.name);
                
                // 驻拽爪 拽  驻砖专 爪 转 拽抓 砖专转
                const canDisplay = canDisplayFile(fileExt, mediaFile.type);
                
                if (canDisplay) {
                    //  驻砖专 爪 转 拽抓 砖专转
                    if (fileExt === 'pdf') {
                        //   PDF, 砖转砖  iframe
                        container.innerHTML = `
                            <div class="file-preview-container">
                                <div class="file-info" style="margin-bottom: 10px;">
                                    <div class="file-download-container">
                                        <div class="file-icon">
                                            <i class="${fileIcon}"></i>
                                        </div>
                                        <div class="file-info">
                                            <div class="file-name">${mediaFile.name || '拽抓'}</div>
                                            <div class="file-size">${fileSize}</div>
                                        </div>
                                        <a href="${downloadInfo.url}" download="${downloadInfo.fileName}" class="download-button">
                                            <i class="fas fa-download"></i>
                                        </a>
                                    </div>
                                </div>
                                <div class="file-preview">
                                    <iframe src="${downloadInfo.url}" width="100%" height="300px" style="border: 1px solid #ddd; border-radius: 4px;"></iframe>
                                </div>
                            </div>
                        `;
                    } else if (fileExt === 'txt' || fileExt === 'html' || fileExt === 'css' || fileExt === 'js') {
                        //   拽抓 拽住, 住 爪 转 转
                        fetch(downloadInfo.url)
                            .then(response => response.text())
                            .then(text => {
                                container.innerHTML = `
                                    <div class="file-preview-container">
                                        <div class="file-info" style="margin-bottom: 10px;">
                                            <div class="file-download-container">
                                                <div class="file-icon">
                                                    <i class="${fileIcon}"></i>
                                                </div>
                                                <div class="file-info">
                                                    <div class="file-name">${mediaFile.name || '拽抓'}</div>
                                                    <div class="file-size">${fileSize}</div>
                                                </div>
                                                <a href="${downloadInfo.url}" download="${downloadInfo.fileName}" class="download-button">
                                                    <i class="fas fa-download"></i>
                                                </a>
                                            </div>
                                        </div>
                                        <div class="file-preview" style="max-height: 200px; overflow: auto; background-color: #f5f5f5; padding: 10px; border-radius: 4px; direction: ltr; text-align: left; font-family: monospace; white-space: pre-wrap;">
                                            ${text.substring(0, 1000)}${text.length > 1000 ? '...' : ''}
                                        </div>
                                    </div>
                                `;
                            })
                            .catch(error => {
                                console.error('砖 注转 拽抓 拽住:', error);
                                //  砖 砖, 爪 专拽 转 注 拽抓
                                displayFileInfoOnly();
                            });
                    } else {
                        // 拽爪 专 砖驻砖专 爪 砖专转
                        displayFileInfoOnly();
                    }
                } else {
                    //  驻砖专 爪 砖专转, 爪 专拽 注 注 拽抓
                    displayFileInfoOnly();
                }
                
                // 驻拽爪 爪转 注 注 拽抓 
                function displayFileInfoOnly() {
                    container.innerHTML = `
                        <div class="file-download-container">
                            <div class="file-icon">
                                <i class="${fileIcon}"></i>
                            </div>
                            <div class="file-info">
                                <div class="file-name">${mediaFile.name || '拽抓'}</div>
                                <div class="file-size">${fileSize}</div>
                            </div>
                            <a href="${downloadInfo.url}" download="${downloadInfo.fileName}" class="download-button">
                                <i class="fas fa-download"></i>
                            </a>
                        </div>
                    `;
                }
                
                return true;
            } catch (error) {
                console.error('砖 驻 拽抓:', error);
                return false;
            }
        }

        // 驻拽爪 拽  转 爪 转 拽抓 砖专转
        function canDisplayFile(extension, mimeType) {
            if (!extension) return false;
            
            const displayableExtensions = ['pdf', 'txt', 'html', 'css', 'js'];
            return displayableExtensions.includes(extension.toLowerCase());
        }

        // 驻拽爪 拽转 住转 拽抓
        function getFileExtension(filename) {
            if (!filename) return '';
            return filename.split('.').pop().toLowerCase();
        }

        // 驻 拽抓 JSON
        function handleJsonFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            showLoader('注 拽抓 JSON...');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    processTelegramExport(jsonData);
                    updateChatView();
                    showStatusMessage('砖 注 爪', 'success');
                } catch (error) {
                    console.error('Error parsing JSON:', error);
                    showStatusMessage('砖 注转 拽抓 -JSON', 'error');
                }
                hideLoader();
            };
            reader.onerror = function() {
                console.error('Error reading JSON file');
                showStatusMessage('砖 拽专转 拽抓 -JSON', 'error');
                hideLoader();
            };
            reader.readAsText(file);
        }
        
        // 驻拽爪 砖专转 转转 注专转
        function saveThumbnails(allFiles, zip) {
            console.log("砖专 转转 注专转...");
            
            // 爪 转  拽爪 砖 转转 注专转
            const thumbnailFiles = allFiles.filter(file => 
                file.path.includes('_thumb.') || 
                file.path.includes('thumbnail')
            );
            
            const thumbnailPromises = thumbnailFiles.map(file => {
                return file.entry.async('blob').then(function(blob) {
                    return new Promise(function(resolve) {
                        const fileName = getFileNameFromPath(file.path);
                        const fileType = getFileType(fileName, blob.type);
                        
                        const reader = new FileReader();
                        reader.onload = function() {
                            // 砖专 转 转 注专转 专 
                            mediaStore.set(file.path, {
                                data: reader.result,
                                type: fileType,
                                name: fileName,
                                path: file.path,
                                is_thumbnail: true
                            });
                            
                            resolve();
                        };
                        reader.readAsDataURL(blob);
                    });
                });
            });
            
            return Promise.all(thumbnailPromises);
        }

        // 驻 拽抓 ZIP 
        async function handleZipFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            showLoader('注 拽抓 ZIP...');
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const data = e.target.result;
                
                try {
                    const zip = await JSZip.loadAsync(data);
                    let mediaCount = 0;
                    let jsonFound = false;
                    let jsonData = null;
                    
                    //  拽爪 
                    const allFiles = [];
                    
                    zip.forEach(function(relativePath, zipEntry) {
                        if (!zipEntry.dir) {
                            allFiles.push({
                                path: relativePath,
                                entry: zipEntry
                            });
                        }
                    });
                    
                    // 驻砖 转 拽抓 -JSON 专砖
                    const jsonFiles = allFiles.filter(file => file.path.endsWith('result.json'));
                    
                    if (jsonFiles.length === 0) {
                        showStatusMessage(' 爪 拽抓 JSON 专砖 (result.json) 专', 'error');
                        hideLoader();
                        return;
                    }
                    
                    // 注 转 转 拽抓 -JSON
                    try {
                        const jsonContent = await jsonFiles[0].entry.async('text');
                        jsonData = JSON.parse(jsonContent);
                        jsonFound = true;
                        processTelegramExport(jsonData);
                        
                        // 注 拽爪 
                        console.log('注 拽爪 ...');

                        // 砖专 转 转 转转 注专转
                        await saveThumbnails(allFiles, zip);

                        // 拽爪 注转 砖专砖 驻 
                        const problematicFiles = [
                            "IMG_2435.MOV",
                            "AnimatedSticker.tgs",
                            "IMG_6855.HEIC",
                            "video.mp4"  //  注
                        ];

                        // 驻  拽爪 注转
                        const specialMediaFiles = allFiles.filter(file => {
                            const fileName = getFileNameFromPath(file.path);
                            return problematicFiles.includes(fileName);
                        });

                        console.log(`爪 ${specialMediaFiles.length} 拽爪 注转`);

                        // 注 拽爪 注转 转
                        const specialPromises = specialMediaFiles.map(file => {
                            return file.entry.async('blob').then(function(blob) {
                                return new Promise(function(resolve) {
                                    const fileName = getFileNameFromPath(file.path);
                                    console.log(`注 拽抓 注转: ${fileName}, : ${blob.size}, 住: ${blob.type}`);
                                    
                                    const reader = new FileReader();
                                    reader.onload = function() {
                                        const fileType = getFileType(fileName, blob.type);
                                        
                                        // 拽  砖 thumbnail 拽抓  砖专 转
                                        const thumbPath = `${file.path}_thumb.jpg`;
                                        const thumbData = mediaStore.get(thumbPath);
                                        
                                        // 砖专 注  专 驻砖专转 砖 拽抓
                                        const mediaData = {
                                            data: reader.result,
                                            type: fileType,
                                            name: fileName,
                                            path: file.path,
                                            size: blob.size
                                        };
                                        
                                        // 住祝 thumbnail  拽
                                        if (thumbData) {
                                            mediaData.thumbnail_data = thumbData.data;
                                        }
                                        
                                        mediaStore.set(fileName, mediaData);
                                        mediaStore.set(file.path, mediaData);
                                        
                                        // 砖专  驻 转 拽
                                        const partialPath = file.path.split('/').pop();
                                        if (partialPath !== fileName) {
                                            mediaStore.set(partialPath, mediaData);
                                        }
                                        
                                        console.log(`拽抓 ${fileName} 砖专 爪`);
                                        resolve();
                                    };
                                    reader.readAsDataURL(blob);
                                });
                            }).catch(error => {
                                console.error(`砖 注 拽抓 ${file.path}:`, error);
                                return Promise.resolve(); // 砖   砖 砖
                            });
                        });

                        await Promise.all(specialPromises);

                        // 注砖 注 转 砖专 拽爪
                        const regularMediaFiles = allFiles.filter(file => {
                            //  注 拽抓 -JSON, 转转 注专转, 拽爪 砖专 注
                            const fileName = getFileNameFromPath(file.path);
                            return file.path !== jsonFiles[0].path && 
                                   !file.path.includes('_thumb.') && 
                                   !file.path.endsWith('.json') &&
                                   !problematicFiles.includes(fileName);
                        });

                        console.log(`注 ${regularMediaFiles.length} 拽爪  专...`);

                        // 注 砖专 拽爪
                        const mediaPromises = regularMediaFiles.map(file => {
                            return file.entry.async('blob').then(function(blob) {
                                return new Promise(function(resolve) {
                                    const fileName = getFileNameFromPath(file.path);
                                    const dirName = getDirNameFromPath(file.path);
                                    const fileType = getFileType(fileName, blob.type);
                                    
                                    const reader = new FileReader();
                                    reader.onload = function() {
                                        // 拽  砖 thumbnail 拽抓  砖专 转
                                        const thumbPath = `${file.path}_thumb.jpg`;
                                        const thumbData = mediaStore.get(thumbPath);
                                        
                                        //  转 拽 
                                        const mediaData = {
                                            data: reader.result,
                                            type: fileType,
                                            name: fileName,
                                            path: file.path,
                                            directory: dirName
                                        };
                                        
                                        // 住祝 thumbnail  拽
                                        if (thumbData) {
                                            mediaData.thumbnail_data = thumbData.data;
                                        }
                                        
                                        // 砖专 转拽 砖 拽抓    转专
                                        mediaStore.set(fileName, mediaData);
                                        
                                        // 砖专  注 转  驻转
                                        mediaStore.set(file.path, mediaData);
                                        
                                        mediaCount++;
                                        if (mediaCount % 10 === 0) {
                                            updateLoaderText(`注 拽爪 ... ${mediaCount}/${regularMediaFiles.length + specialMediaFiles.length}`);
                                        }
                                        resolve();
                                    };
                                    reader.readAsDataURL(blob);
                                });
                            }).catch(error => {
                                console.error(`砖 注 拽抓 ${file.path}:`, error);
                                return Promise.resolve(); // 砖   砖 砖
                            });
                        });

                        await Promise.all(mediaPromises);
                        console.log('专 :', Array.from(mediaStore.keys()));
                        updateChatView();
                        showStatusMessage(`砖 注 爪 注 ${mediaCount + specialMediaFiles.length} 拽爪 `, 'success');
                        hideLoader();
                        
                    } catch (error) {
                        console.error('Error parsing JSON:', error);
                        showStatusMessage('砖 注 拽抓 -JSON', 'error');
                        hideLoader();
                    }
                } catch (error) {
                    console.error('Error loading zip file:', error);
                    showStatusMessage('砖 驻转转 拽抓 专', 'error');
                    hideLoader();
                }
            };
            
            reader.onerror = function() {
                console.error('Error reading zip file');
                showStatusMessage('砖 拽专转 拽抓 专', 'error');
                hideLoader();
            };
            
            reader.readAsArrayBuffer(file);
        }

        // 抓 砖 拽抓 转
        function getFileNameFromPath(path) {
            if (path.includes('/')) {
                //  砖 转 转拽转, 拽 专拽 转 拽 专
                const parts = path.split('/');
                return parts[parts.length - 1];
            }
            return path;
        }
        
        // 抓 砖 转拽 转
        function getDirNameFromPath(path) {
            if (path.includes('/')) {
                const parts = path.split('/');
                if (parts.length > 1) {
                    return parts[parts.length - 2]; // 转拽 专
                }
            }
            return '';
        }
        
        // 拽  拽抓  拽抓 
        function isMediaFile(fileName) {
            const mediaExtensions = [
                '.jpg', '.jpeg', '.png', '.gif', '.webp', '.tgs',  // 转转 住拽专
                '.mp4', '.avi', '.mov', '.webm',                   // 
                '.mp3', '.ogg', '.wav', '.m4a', '.opus',           // 
                '.pdf', '.doc', '.docx',                           // 住
                '.tgz', '.zip', '.rar'                             // 专
            ];
            
            const lowerName = fileName.toLowerCase();
            
            // 转转  砖转 拽爪 专
            const telegramFilePatterns = [
                'photo_', 'video_', 'audio_', 'voice_', 
                'sticker_', 'animation_', 'document_',
                'round_video_', 'profile_photo_'
            ];
            
            // 拽 住转 拽抓
            const hasMediaExtension = mediaExtensions.some(ext => lowerName.endsWith(ext));
            
            // 拽 转转 砖转 拽爪 砖 专
            const hasTelegramPattern = telegramFilePatterns.some(pattern => lowerName.includes(pattern));
            
            // 拽   拽抓 thumbnail
            const isThumbnail = lowerName.includes('_thumb') || lowerName.includes('_thumbnail');
            
            return hasMediaExtension || hasTelegramPattern || isThumbnail;
        }
        
        //  住 拽抓
        function getFileType(fileName, fallbackType) {
            const lowerName = typeof fileName === 'string' ? fileName.toLowerCase() : '';
            
            // Match by extension for better type detection
            if (lowerName.endsWith('.jpg') || lowerName.endsWith('.jpeg') || lowerName.includes('photo_')) {
                return 'image/jpeg';
            }
            if (lowerName.endsWith('.png')) {
                return 'image/png';
            }
            if (lowerName.endsWith('.heic') || lowerName.endsWith('.HEIC')) {
                return 'image/heic'; // HEIC format
            }
            if (lowerName.endsWith('.mp4') || lowerName.includes('video_')) {
                return 'video/mp4';
            }
            if (lowerName.endsWith('.mov') || lowerName.endsWith('.MOV')) {
                return 'video/quicktime'; // MOV format
            }
            if (lowerName.includes('round_video_')) {
                return 'video/mp4';
            }
            if (lowerName.endsWith('.ogg') || lowerName.endsWith('.opus') || lowerName.includes('voice_')) {
                return 'audio/ogg';
            }
            if (lowerName.endsWith('.mp3') || lowerName.includes('audio_')) {
                return 'audio/mp3';
            }
            if (lowerName.endsWith('.webp') || lowerName.includes('sticker_')) {
                return 'image/webp';
            }
            if (lowerName.endsWith('.tgs')) {
                return 'application/x-tgsticker';
            }
            if (lowerName.endsWith('.gif') || lowerName.includes('animation_')) {
                return 'image/gif';
            }
            
            // Add more file types as needed
            if (lowerName.endsWith('.pdf')) return 'application/pdf';
            if (lowerName.endsWith('.doc') || lowerName.endsWith('.docx')) return 'application/msword';
            if (lowerName.endsWith('.wav')) return 'audio/wav';
            if (lowerName.endsWith('.m4a')) return 'audio/m4a';
            
            // Return fallback type if provided
            return fallbackType || 'application/octet-stream';
        }

        // ===================================================
        // ================ 注 爪 专 ================
        // ===================================================
        
        // 驻拽爪 注 爪 砖 专
        function processTelegramExport(data) {
            // 拽 专 砖转转驻 拽
            participants.clear();
            
            // 注 注 注 砖
            if (data.name) {
                chatData.name = data.name;
            } else if (data.chat && data.chat.name) {
                chatData.name = data.chat.name;
            } else {
                chatData.name = 'Telegram Chat';
            }
            
            if (data.type) {
                chatData.type = data.type;
            } else if (data.chat && data.chat.type) {
                chatData.type = data.chat.type;
            } else {
                chatData.type = 'private';
            }
            
            chatData.about = data.about || (data.chat && data.chat.about) || '';
            
            //  砖转砖 
            if (data.personal_information) {
                currentUser.id = data.personal_information.user_id || null;
                currentUser.name = data.personal_information.first_name || '';
                if (data.personal_information.last_name) {
                    currentUser.name += ' ' + data.personal_information.last_name;
                }
                currentUser.username = data.personal_information.username || '';
            }
            
            // 注 专砖转 砖转转驻/砖 拽砖专
            const usersData = data.users || (data.chat && data.chat.users) || [];
            
            usersData.forEach(user => {
                let userName = user.first_name || '';
                if (user.last_name) {
                    userName += ' ' + user.last_name;
                }
                
                //   砖, 砖转砖 砖 砖转砖
                if (!userName && user.username) {
                    userName = user.username;
                }
                
                //  注  砖, 砖转砖 
                if (!userName) {
                    userName = `User ${user.id}`;
                }
                
                // 住祝 转 砖转砖 专 砖转转驻
                addParticipant(user.id, userName, user.username);
            });
            
            // 注 注转
            chatData.messages = [];
            
            const messagesData = data.messages || (data.chat && data.chat.messages) || [];
            
            messagesData.forEach(msg => {
                // 驻 住 砖 砖 注转
                if (msg.type === 'service' || msg.action) {
                    // 注转 砖专转 (爪专驻转/注/砖 砖 ')
                    chatData.messages.push({
                        id: msg.id,
                        type: 'service',
                        date: formatDate(msg.date),
                        text: msg.text || msg.action || '',
                        action: msg.action || ''
                    });
                } else {
                    // 注 专
                    let isOutgoing = false;
                    let senderId = msg.from_id;
                    
                    // 拽  注  爪转 (砖 注" 砖转砖 )
                    if (msg.from_id === currentUser.id || msg.out || msg.outgoing) {
                        isOutgoing = true;
                    }
                    
                    // 拽 驻专, -ID 砖 砖 爪 转转 'from'
                    if (!senderId && msg.from) {
                        if (typeof msg.from === 'object' && msg.from.id) {
                            senderId = msg.from.id;
                        } else if (typeof msg.from === 'string' || typeof msg.from === 'number') {
                            senderId = msg.from;
                        }
                    }
                    
                    // 拽 砖 砖
                    let senderName = msg.from_name || '';
                    
                    //   砖 驻专砖, 住 爪 转 砖 专砖转 砖转转驻
                    if (!senderName && senderId && participants.has(senderId)) {
                        senderName = participants.get(senderId).name;
                    } else if (!senderName && msg.from) {
                        //  砖 拽 'from', 拽 转 砖 
                        if (typeof msg.from === 'object') {
                            senderName = msg.from.first_name || '';
                            if (msg.from.last_name) {
                                senderName += ' ' + msg.from.last_name;
                            }
                        } else {
                            senderName = String(msg.from);
                        }
                    }
                    
                    //  注  砖 砖, 专  注
                    if (!senderName) {
                        senderName = 'Unknown';
                    }
                    
                    // 拽  砖 专 拽 专砖转 砖转转驻,   - 住祝 转
                    if (senderId && !participants.has(senderId)) {
                        addParticipant(senderId, senderName, null);
                    }
                    
                    //  转 注
                    const messageText = msg.text || '';
                    
                    // 驻砖 转 拽抓  转
                    let mediaType = null;
                    let mediaFile = null;
                    let mediaFileId = null;
                    let mediaDuration = null;
                    let fileName = null;
                    
                    // 拽 转  住  驻砖专
                    if (msg.photo) {
                        mediaType = 'photo';
                        mediaFile = msg.photo;
                        mediaFileId = getMediaId(msg.photo, 'photo');
                    } else if (msg.video) {
                        mediaType = 'video';
                        mediaFile = msg.video;
                        mediaFileId = getMediaId(msg.video, 'video');
                        mediaDuration = msg.video.duration;
                    } else if (msg.file) {
                        // 驻 拽爪 住住 注 media_type
                        if (msg.media_type === 'video_file' || msg.mime_type?.includes('video')) {
                            mediaType = 'video';
                            fileName = msg.file_name;
                        } else if (msg.media_type === 'voice_message') {
                            mediaType = 'voice';
                            fileName = msg.file_name;
                        } else if (msg.media_type === 'video_message') {
                            mediaType = 'video_note';
                            fileName = msg.file_name;
                        } else if (msg.media_type === 'sticker') {
                            mediaType = 'sticker';
                            fileName = msg.file_name;
                        } else if (msg.media_type === 'animation') {
                            mediaType = 'animation';
                            fileName = msg.file_name;
                        } else {
                            mediaType = 'document';
                            fileName = msg.file_name;
                        }
                        
                        mediaFile = msg.file;
                        mediaFileId = getFileNameFromPath(msg.file);
                        mediaDuration = msg.duration_seconds;
                    } else if (msg.voice) {
                        mediaType = 'voice';
                        mediaFile = msg.voice;
                        mediaFileId = getMediaId(msg.voice, 'voice');
                        mediaDuration = msg.voice.duration;
                    } else if (msg.audio) {
                        mediaType = 'audio';
                        mediaFile = msg.audio;
                        mediaFileId = getMediaId(msg.audio, 'audio');
                        mediaDuration = msg.audio.duration;
                    } else if (msg.sticker) {
                        mediaType = 'sticker';
                        mediaFile = msg.sticker;
                        mediaFileId = getMediaId(msg.sticker, 'sticker');
                    } else if (msg.animation) {
                        mediaType = 'animation';
                        mediaFile = msg.animation;
                        mediaFileId = getMediaId(msg.animation, 'animation');
                    } else if (msg.document || msg.file) {
                        mediaType = 'document';
                        mediaFile = msg.document || msg.file;
                        mediaFileId = getMediaId(msg.document || msg.file, 'document');
                        fileName = msg.file_name;
                    } else if (msg.location) {
                        mediaType = 'location';
                        mediaFile = null;
                        mediaFileId = null;
                    } else if (msg.poll) {
                        mediaType = 'poll';
                        mediaFile = null;
                        mediaFileId = null;
                    } else if (msg.video_note) {
                        mediaType = 'video_note';
                        mediaFile = msg.video_note;
                        mediaFileId = getMediaId(msg.video_note, 'round_video');
                        mediaDuration = msg.video_note.duration;
                    }
                    
                    // 爪专转 拽 注 砖
                    const message = {
                        id: msg.id,
                        type: 'message',
                        date: formatDate(msg.date),
                        time: formatTime(msg.date),
                        timestamp: new Date(msg.date).getTime(),
                        sender: senderName,
                        senderId: senderId,
                        text: messageText,
                        isOutgoing: isOutgoing,
                        edited: msg.edited || false,
                        forwarded: msg.forwarded_from ? true : false,
                        forwarded_from: msg.forwarded_from || null,
                        reply_to: msg.reply_to_message_id || null,
                        mediaType: mediaType,
                        mediaFile: mediaFile,
                        mediaFileId: mediaFileId,
                        mediaDuration: mediaDuration,
                        file: msg.file,                     // 砖专转 转 拽抓 拽专
                        file_name: fileName || msg.file_name,  // 砖专转 砖 拽抓
                        sticker_emoji: msg.sticker_emoji,   // ' 砖 住拽专
                        mime_type: msg.mime_type,           // 住 MIME
                        media_type: msg.media_type,         // 住  驻 砖专 专
                        views: msg.views || 0,
                        reactions: msg.reactions || [],
                        thumbnail: msg.thumbnail         // 转 转 注专转
                    };

                    // 驻 砖 拽砖专
                    if (msg.contact_information) {
                        message.mediaType = 'contact';
                        message.contact = msg.contact_information;
                    }

                    // 驻 拽
                    if (msg.location_information) {
                        message.mediaType = 'location';
                        message.location = msg.location_information;
                    }

                    // 拽 住驻转 住拽专
                    if (message.mediaType === 'sticker' && msg.file && msg.file.endsWith('.tgs')) {
                        message.is_animated_sticker = true;
                    }

                    // 拽 转 拽爪 HEIC
                    if (message.file_name && message.file_name.toLowerCase().endsWith('.heic')) {
                        message.is_heic = true;
                    }

                    // 驻 住驻爪驻 拽爪 MOV
                    if (message.file_name && message.file_name.toLowerCase().endsWith('.mov')) {
                        message.mediaType = 'video';
                    }

                    // 住驻转 注 注 转 注专转
                    if (msg.thumbnail) {
                        message.thumbnail = msg.thumbnail;
                        message.thumbnail_file_size = msg.thumbnail_file_size;
                    }
                    
                    chatData.messages.push(message);
                }
            });
            
            //  注转 驻 转专
            chatData.messages.sort((a, b) => {
                if (a.timestamp && b.timestamp) {
                    return a.timestamp - b.timestamp;
                }
                return 0;
            });
        }

        // 驻拽爪 抓   拽 
        function getMediaId(mediaObj, type) {
            if (!mediaObj) return null;
            
            // 住 爪   驻专 砖
            if (mediaObj.file_id) {
                return mediaObj.file_id;
            }
            
            if (mediaObj.id) {
                return `${type}_${mediaObj.id}`;
            }
            
            if (mediaObj.file_name) {
                return mediaObj.file_name;
            }
            
            if (mediaObj.file_path) {
                return getFileNameFromPath(mediaObj.file_path);
            }
            
            //    驻专砖, 专 null
            return null;
        }
        
        // 驻专 转专
        function formatDate(dateString) {
            // 拽   转专 转拽
            if (!dateString) return '';
            
            const date = new Date(dateString);
            
            // 拽  转专 转拽
            if (isNaN(date.getTime())) return dateString;
            
            return date.toLocaleDateString('he-IL', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit' 
            });
        }
        
        // 驻专 砖注
        function formatTime(dateString) {
            // 拽   转专 转拽
            if (!dateString) return '';
            
            const date = new Date(dateString);
            
            // 拽  转专 转拽
            if (isNaN(date.getTime())) return '';
            
            return date.toLocaleTimeString('he-IL', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }
        
        // 驻专 砖  (住专 注转 拽转)
        function formatDuration(seconds) {
            if (!seconds || isNaN(seconds)) return '00:00';
            
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // ===================================================
        // ==================  砖转转驻 ==================
        // ===================================================
        
        // 爪专转 爪注 专  砖转转祝
        function generateRandomColor() {
            // 爪注 住 专
            const colors = [
                '#5682a3', '#4fad2d', '#d55555', '#a85e93',
                '#e17076', '#f2a45c', '#7ec4ea', '#65aadd',
                '#9a86bd', '#5fbed5', '#76c84d', '#ff5555',
                '#ffa85c', '#82b1ff', '#0088cc', '#36a3e5',
                '#69b4ff', '#ff708e', '#c67171', '#9b7dd4'
            ];
            
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        // 住驻转 砖转转祝 砖
        function addParticipant(id, name, username) {
            //  砖-ID  专转
            const participantId = String(id);
            
            if (!participants.has(participantId)) {
                participants.set(participantId, {
                    id: participantId,
                    name: name,
                    username: username || '',
                    color: generateRandomColor(),
                    avatar: null
                });
            }
            return participants.get(participantId);
        }
        
        // 注 专砖转 砖转转驻 驻
        function updateParticipantsList() {
            const container = document.getElementById('participants-list');
            
            if (participants.size === 0) {
                container.innerHTML = `
                    <div class="no-participants">
                        <p> 砖转转驻 爪. 注 拽抓 砖 转.</p>
                    </div>
                `;
                return;
            }
            
            let participantsHtml = '';
            
            participants.forEach((participant, id) => {
                const initialLetter = participant.name.charAt(0);
                let avatarContent = '';
                
                if (participant.avatar) {
                    avatarContent = `<img src="${participant.avatar}" alt="${participant.name}">`;
                } else {
                    avatarContent = initialLetter;
                }
                
                participantsHtml += `
                    <div class="participant-item" data-id="${id}">
                        <div class="participant-avatar" style="background-color: ${participant.color}">
                            ${avatarContent}
                        </div>
                        <div class="participant-info">
                            <div class="participant-name">
                                <span class="participant-color-preview" style="background-color: ${participant.color}"></span>
                                ${participant.name}
                                ${participant.username ? `(@${participant.username})` : ''}
                            </div>
                            <div class="color-picker-container">
                                <span class="color-picker-label">爪注:</span>
                                <input type="color" class="participant-color" value="${participant.color}" 
                                    data-id="${id}" onchange="updateParticipantColor('${id}', this.value)">
                            </div>
                        </div>
                        <div class="participant-actions">
                            <label class="participant-upload">
                                <i class="fas fa-image"></i>
                                <input type="file" accept="image/*" style="display: none;" 
                                    data-id="${id}" onchange="handleParticipantAvatarUpload(event, '${id}')">
                            </label>
                            
                            <button class="remove-image-btn" 
                                onclick="removeParticipantAvatar('${id}')" 
                                style="display: ${participant.avatar ? 'inline-block' : 'none'};">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = participantsHtml;
        }
        
        // 注 爪注 砖转转祝
        function updateParticipantColor(id, color) {
            if (participants.has(id)) {
                participants.get(id).color = color;
                updateParticipantsList();
                updateChatView();
            }
        }
        
        // 驻 注转 转 砖转转祝
        function handleParticipantAvatarUpload(event, id) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                if (participants.has(id)) {
                    participants.get(id).avatar = e.target.result;
                    updateParticipantsList();
                    updateChatView();
                }
            };
            
            reader.readAsDataURL(file);
        }
        
        // 住专转 转转 砖转转祝
        function removeParticipantAvatar(id) {
            if (participants.has(id)) {
                participants.get(id).avatar = null;
                updateParticipantsList();
                updateChatView();
            }
        }
        
        // 驻转转 驻 砖转转驻
        function openParticipantsPanel() {
            updateParticipantsList();
            document.getElementById('participants-panel').style.display = 'flex';
        }
        
        // 住专转 驻 砖转转驻
        function closeParticipantsPanel() {
            document.getElementById('participants-panel').style.display = 'none';
        }

        // ===================================================
        // ================ 驻 专转 专 ================
        // ===================================================
        
        // 驻 注转 转转 驻专驻
        function handleProfileImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                appSettings.profileImage = e.target.result;
                updateProfilePreview();
                updateChatView();
                document.getElementById('remove-profile-image').style.display = 'inline-block';
            };
            reader.readAsDataURL(file);
        }
        
        // 驻 注转 转转 专拽注
        function handleBackgroundImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                appSettings.backgroundImage = e.target.result;
                updateBackgroundPreview();
                updateChatView();
                document.getElementById('remove-background-image').style.display = 'inline-block';
            };
            reader.readAsDataURL(file);
        }
        
        // 注 转爪 拽 砖 转转 驻专驻
        function updateProfilePreview() {
            const preview = document.getElementById('profile-preview');
            const initial = document.getElementById('profile-initial');
            
            if (appSettings.profileImage) {
                preview.innerHTML = `<img src="${appSettings.profileImage}" alt="转转 驻专驻">`;
            } else {
                preview.innerHTML = '';
                initial.textContent = chatData.name ? chatData.name.charAt(0) : '?';
                preview.appendChild(initial);
            }
        }
        
        // 注 转爪 拽 砖 转转 专拽注
        function updateBackgroundPreview() {
            const preview = document.getElementById('background-preview');
            
            if (appSettings.backgroundImage) {
                preview.style.backgroundImage = `url(${appSettings.backgroundImage})`;
                preview.style.border = 'none';
            } else {
                preview.style.backgroundImage = 'none';
                preview.style.border = '2px dashed #ddd';
            }
        }
        
        // 住专转 转转 驻专驻
        function removeProfileImage() {
            appSettings.profileImage = null;
            document.getElementById('profile-image-input').value = '';
            document.getElementById('remove-profile-image').style.display = 'none';
            updateProfilePreview();
            updateChatView();
        }
        
        // 住专转 转转 专拽注
        function removeBackgroundImage() {
            appSettings.backgroundImage = null;
            document.getElementById('background-image-input').value = '';
            document.getElementById('remove-background-image').style.display = 'none';
            updateBackgroundPreview();
            updateChatView();
        }
        
        // 驻转转 驻 专转
        function openSettingsPanel() {
            // 注 转爪 拽 驻 驻转转 驻
            updateProfilePreview();
            updateBackgroundPreview();
            
            // 爪转/住转专转 驻转专 住专 转 爪
            document.getElementById('remove-profile-image').style.display = 
                appSettings.profileImage ? 'inline-block' : 'none';
                
            document.getElementById('remove-background-image').style.display = 
                appSettings.backgroundImage ? 'inline-block' : 'none';
            
            // 爪转 驻
            document.getElementById('settings-panel').style.display = 'flex';
        }
        
        // 住专转 驻 专转
        function closeSettingsPanel() {
            document.getElementById('settings-panel').style.display = 'none';
        }

        // ===================================================
        // ================ 注 转爪转 砖 ================
        // ===================================================
        
        function updateChatView() {
            if (chatData.messages.length === 0) return;
            
            const container = document.getElementById('chat-container');
            const firstLetter = chatData.name.charAt(0);
            
            // 爪专转 转转 砖 注 转 转转 驻专驻
            let avatarContent = '';
            if (appSettings.profileImage) {
                avatarContent = `<img src="${appSettings.profileImage}" alt="转转 驻专驻">`;
            } else {
                avatarContent = firstLetter;
            }
            
            // 住驻转 注 住驻爪驻 专
            let chatTypeInfo = '';
            if (chatData.type === 'private') {
                chatTypeInfo = '砖 驻专转';
            } else if (chatData.type === 'group') {
                chatTypeInfo = '拽爪';
            } else if (chatData.type === 'channel') {
                chatTypeInfo = '注专抓';
            } else if (chatData.type === 'supergroup') {
                chatTypeInfo = '住驻专-拽爪';
            } else {
                chatTypeInfo = `${chatData.messages.length} 注转`;
            }
            
            container.innerHTML = `
                <div class="chat-header">
                    <div class="avatar">${avatarContent}</div>
                    <div class="chat-info">
                        <h2>${chatData.name}</h2>
                        <p>${chatTypeInfo}</p>
                    </div>
                </div>
                <div class="chat-body ${appSettings.backgroundImage ? 'has-background' : ''}">
                    <div id="messages-container"></div>
                </div>
            `;
            
            // 专 专拽注  拽
            const chatBody = document.querySelector('.chat-body');
            if (appSettings.backgroundImage) {
                chatBody.style.backgroundImage = `url(${appSettings.backgroundImage})`;
            } else {
                chatBody.style.backgroundImage = 'none';
            }
            
            const messagesContainer = document.getElementById('messages-container');
            let currentDate = null;
            
            // 爪专转 注转
            chatData.messages.forEach(message => {
                // 住驻转 转专转 转专  转专 砖转
                if (message.date !== currentDate) {
                    currentDate = message.date;
                    const dateHeader = document.createElement('div');
                    dateHeader.className = 'date-header';
                    dateHeader.innerHTML = `<span>${currentDate}</span>`;
                    messagesContainer.appendChild(dateHeader);
                }
                
                // 驻 注转 砖专转
                if (message.type === 'service') {
                    const serviceElement = document.createElement('div');
                    serviceElement.className = 'service-message';
                    serviceElement.innerHTML = `<span>${message.text}</span>`;
                    messagesContainer.appendChild(serviceElement);
                    return;
                }
                
                // 爪专转  注
                const messageElement = document.createElement('div');
                messageElement.className = `message ${message.isOutgoing ? 'out' : 'in'}`;
                
                // 注转 注
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                
                // 砖 砖 (专拽 注转 砖转拽)
                if (!message.isOutgoing && chatData.type !== 'private' && message.sender) {
                    const senderElement = document.createElement('div');
                    senderElement.className = 'sender';
                    
                    // 拽 转 砖转转祝
                    const participant = participants.get(message.senderId);
                    if (participant) {
                        senderElement.style.color = participant.color;
                    }
                    
                    senderElement.textContent = message.sender;
                    bubble.appendChild(senderElement);
                }
                
                // 住驻转 转 住专 拽  砖
                if (message.reply_to) {
                    const replyElement = document.createElement('div');
                    replyElement.className = 'reply-to';
                    
                    // 驻砖 注 拽专转
                    const originalMessage = chatData.messages.find(msg => msg.id === message.reply_to);
                    
                    if (originalMessage) {
                        const replySender = originalMessage.sender || 'Unknown';
                        const replyText = originalMessage.text || 
                                           (originalMessage.mediaType ? `[${originalMessage.mediaType}]` : '');
                        
                        replyElement.innerHTML = `
                            <div class="reply-sender">${replySender}</div>
                            <div class="reply-content">${replyText}</div>
                        `;
                    } else {
                        replyElement.textContent = '转 注';
                    }
                    
                    bubble.appendChild(replyElement);
                }
                
                // 住驻转 爪 注专  砖
                if (message.forwarded && message.forwarded_from) {
                    const forwardedElement = document.createElement('div');
                    forwardedElement.className = 'message-note message-forwarded';
                    forwardedElement.innerHTML = `<i class="fas fa-share"></i> 注专 -${message.forwarded_from}`;
                    bubble.appendChild(forwardedElement);
                }
                
                // 驻 住  砖
                if (message.mediaType) {
                    const mediaElement = createMediaElement(message);
                    if (mediaElement) {
                        bubble.appendChild(mediaElement);
                    }
                }
                
                // 转 注转 拽住
                if (message.text) {
                    const contentElement = document.createElement('div');
                    contentElement.className = 'message-content';
                    contentElement.textContent = message.text;
                    bubble.appendChild(contentElement);
                }
                
                // 住驻转 转转 (reactions)  砖
                if (message.reactions && message.reactions.length > 0) {
                    const reactionsElement = document.createElement('div');
                    reactionsElement.className = 'reactions';
                    
                    message.reactions.forEach(reaction => {
                        // 拽 驻专 砖转砖 -emoji 砖专转, 拽 砖转砖 拽
                        const emoji = reaction.emoji || (reaction.reaction ? reaction.reaction : '');
                        const count = reaction.count || 1;
                        
                        reactionsElement.innerHTML += `
                            <div class="reaction">
                                <span class="emoji">${emoji}</span>
                                <span class="count">${count}</span>
                            </div>
                        `;
                    });
                    
                    bubble.appendChild(reactionsElement);
                }
                
                // 住祝 注专  注 注专
                if (message.edited) {
                    const noteElement = document.createElement('div');
                    noteElement.className = 'message-note message-edited';
                    noteElement.innerHTML = `<i class="fas fa-edit"></i> 注专`;
                    bubble.appendChild(noteElement);
                }
                
                // 注 注 爪驻转 (注专爪)
                if (message.views && message.views > 0 && (chatData.type === 'channel' || chatData.type === 'supergroup')) {
                    const viewsElement = document.createElement('span');
                    viewsElement.className = 'message-views';
                    viewsElement.innerHTML = `<i class="fas fa-eye"></i> ${message.views}`;
                    bubble.appendChild(viewsElement);
                }
                
                // 砖注转 注
                const timeElement = document.createElement('div');
                timeElement.className = 'message-time';
                timeElement.textContent = message.time;
                bubble.appendChild(timeElement);
                
                // 住驻  注转
                messageElement.appendChild(bubble);
                messagesContainer.appendChild(messageElement);
            });
            
            //  转转转 砖
            chatBody.scrollTop = chatBody.scrollHeight;
            
            // 驻注  专注 转转
            setupImageEventListeners();
            onChatLoaded();
        }
        
        // 爪专转   转 住
        function createMediaElement(message) {
            if (!message.mediaType) return null;
            
            const mediaContainer = document.createElement('div');
            
            // 注转 住驻专转 爪转   注 专
            loadExternalLibraries();
            
            // 爪 拽抓  转
            const mediaFile = findMediaFile(message);
            
            // 爪专转   
            const elementId = 'media_' + message.id + '_' + Math.random().toString(36).substr(2, 5);
            mediaContainer.id = elementId;
            
            switch (message.mediaType) {
                case 'photo':
                    mediaContainer.className = 'attachment';
                    if (mediaFile) {
                        // 拽  专 拽抓 HEIC 砖专砖 驻 
                        if (message.is_heic || (mediaFile.name && mediaFile.name.toLowerCase().endsWith('.heic'))) {
                            // 爪专转 拽砖专 专
                            const downloadInfo = createDownloadableFile(mediaFile, mediaFile.name || 'image.heic');
                            
                            // 拽  砖 转 注专转
                            if (message.thumbnail && mediaStore.has(message.thumbnail)) {
                                const thumbFile = mediaStore.get(message.thumbnail);
                                mediaContainer.innerHTML = `
                                    <div class="heic-container">
                                        <img src="${thumbFile.data}" alt="转爪 拽 (HEIC)" class="attachment-image">
                                        <div class="heic-info">拽抓 HEIC -  转 砖专转 驻驻</div>
                                        <a href="${downloadInfo.url}" download="${downloadInfo.fileName}" class="download-link">
                                            <i class="fas fa-download"></i> 专 转 转 拽专转
                                        </a>
                                    </div>
                                `;
                            } else {
                                mediaContainer.innerHTML = `
                                    <div class="attachment-file">
                                        <i class="fas fa-image"></i>
                                        <span>转转 HEIC (${mediaFile.name || '转'})</span>
                                        <a href="${downloadInfo.url}" download="${downloadInfo.fileName}" class="download-link">
                                            <i class="fas fa-download"></i> 专 转 转 拽专转
                                        </a>
                                    </div>
                                `;
                            }
                        } else {
                            // 转 专 砖驻驻  爪
                            mediaContainer.innerHTML = `
                                <img src="${mediaFile.data}" alt="转" 
                                     data-path="${encodeURIComponent(mediaFile.path || '')}" 
                                     class="attachment-image">
                            `;
                        }
                    } else {
                        //   拽抓,  砖 转 注专转, 爪 转 注专转
                        if (message.thumbnail && mediaStore.has(message.thumbnail)) {
                            const thumbFile = mediaStore.get(message.thumbnail);
                            mediaContainer.innerHTML = `
                                <img src="${thumbFile.data}" alt="转爪 拽" 
                                    class="attachment-image">
                                <div class="preview-note">转爪 拽 </div>
                            `;
                        } else {
                            mediaContainer.innerHTML = `
                                <div class="attachment-file">
                                    <i class="fas fa-image"></i>
                                    <span>转 (${message.file_name || '拽抓  爪'})</span>
                                </div>
                            `;
                        }
                    }
                    break;
                    
                case 'video':
                    mediaContainer.className = 'video-container';
                    if (mediaFile) {
                        // 拽   拽抓 MOV
                        if (message.file_name && message.file_name.toLowerCase().endsWith('.mov')) {
                            // 砖转砖 驻拽爪 转 驻 拽爪 MOV
                            setTimeout(() => handleMovVideo(mediaFile, elementId), 0);
                            mediaContainer.innerHTML = `<div class="loading-media">注 ...</div>`;
                        } else {
                            //  专 砖驻驻  爪
                            let durationText = '';
                            if (message.mediaDuration) {
                                durationText = `<div class="video-duration">${formatDuration(message.mediaDuration)}</div>`;
                            }
                            
                            // 拽  砖 转 注专转 砖砖 -poster
                            const thumbnailData = mediaFile.thumbnail_data || 
                                (message.thumbnail && mediaStore.has(message.thumbnail) ? 
                                    mediaStore.get(message.thumbnail).data : null);
                            
                            mediaContainer.innerHTML = `
                                <video controls width="100%" ${thumbnailData ? `poster="${thumbnailData}"` : ''}>
                                    <source src="${mediaFile.data}" type="${mediaFile.type || 'video/mp4'}">
                                    驻驻 砖  转 爪转 
                                </video>
                                ${durationText}
                            `;
                        }
                    } else {
                        //   拽抓 , 拽  砖 转 注专转
                        if (message.thumbnail && mediaStore.has(message.thumbnail)) {
                            const thumbFile = mediaStore.get(message.thumbnail);
                            mediaContainer.innerHTML = `
                                <div class="video-thumbnail">
                                    <img src="${thumbFile.data}" alt="转爪 拽 砖 " class="attachment-image">
                                    <div class="video-play-icon"><i class="fas fa-play-circle"></i></div>
                                    <div class="video-info"> 转 爪 转 : ${message.file_name || message.file || '拽抓 '}</div>
                                </div>
                            `;
                        } else {
                            mediaContainer.innerHTML = `
                                <div class="attachment-file">
                                    <i class="fas fa-video"></i>
                                    <span> (${message.file_name || message.file || '拽抓  爪'})</span>
                                </div>
                            `;
                        }
                    }
                    break;
                    
                case 'sticker':
                    mediaContainer.className = 'sticker';
                    if (mediaFile) {
                        // 拽  专 住拽专 驻砖 (TGS)
                        if (message.is_animated_sticker || (mediaFile.name && mediaFile.name.toLowerCase().endsWith('.tgs'))) {
                            // 砖转砖 驻拽爪 转 驻 住拽专 驻砖
                            setTimeout(() => renderTgsSticker(mediaFile, elementId), 0);
                            mediaContainer.innerHTML = `<div class="loading-media">注 住拽专...</div>`;
                        } else {
                            // 住拽专 专
                            mediaContainer.innerHTML = `
                                <img src="${mediaFile.data}" alt="住拽专" 
                                     data-path="${encodeURIComponent(mediaFile.path || '')}" 
                                     class="attachment-image">
                            `;
                        }
                    } else {
                        // 拽  砖 转 注专转
                        if (message.thumbnail && mediaStore.has(message.thumbnail)) {
                            const thumbFile = mediaStore.get(message.thumbnail);
                            mediaContainer.innerHTML = `
                                <img src="${thumbFile.data}" alt="住拽专 (转爪 拽)" class="attachment-image">
                            `;
                        } else {
                            const emoji = message.sticker_emoji || '';
                            mediaContainer.innerHTML = `
                                <div class="sticker-placeholder">
                                    <span class="sticker-emoji">${emoji}</span>
                                    <span>住拽专</span>
                                </div>
                            `;
                        }
                    }
                    break;
                    
                case 'voice':
                    mediaContainer.className = 'voice-message';
                    if (mediaFile) {
                        const duration = message.mediaDuration ? formatDuration(message.mediaDuration) : '--:--';
                        mediaContainer.innerHTML = `
                            <i class="fas fa-microphone"></i>
                            <audio controls>
                                <source src="${mediaFile.data}" type="${mediaFile.type || 'audio/ogg'}">
                                驻驻 砖  转 爪转 
                            </audio>
                            <span class="voice-message-duration">${duration}</span>
                        `;
                    } else {
                        mediaContainer.innerHTML = `
                            <i class="fas fa-microphone"></i>
                            <span>注 拽转 (${message.file_name || message.file || '拽抓  爪'})</span>
                        `;
                    }
                    break;
                    
                case 'document':
                    mediaContainer.className = 'document-container';
                    if (mediaFile) {
                        // 砖转砖 驻拽爪 驻 拽爪  注 驻砖专转 专
                        setTimeout(() => handleGenericFile(mediaFile, elementId), 0);
                        mediaContainer.innerHTML = `<div class="loading-media">注 拽抓...</div>`;
                    } else {
                        let fileName = message.file_name || '';
                        mediaContainer.innerHTML = `
                            <div class="document-icon">
                                <i class="fas fa-file"></i>
                            </div>
                            <div class="document-info">
                                <div class="document-title">${fileName || '拽抓'}</div>
                                <div class="document-status">(拽抓  爪)</div>
                            </div>
                        `;
                    }
                    break;
                    
                case 'video_note':
                    mediaContainer.className = 'video-note';
                    if (mediaFile) {
                        mediaContainer.innerHTML = `
                            <video controls autoplay loop>
                                <source src="${mediaFile.data}" type="${mediaFile.type || 'video/mp4'}">
                                驻驻 砖  转 爪转 
                            </video>
                        `;
                    } else {
                        // 拽  砖 转 注专转
                        if (message.thumbnail && mediaStore.has(message.thumbnail)) {
                            const thumbFile = mediaStore.get(message.thumbnail);
                            mediaContainer.innerHTML = `
                                <div class="video-note-thumbnail" style="border-radius: 50%; overflow: hidden;">
                                    <img src="${thumbFile.data}" alt=" 注 (转爪 拽)" style="width: 150px; height: 150px; object-fit: cover;">
                                </div>
                            `;
                        } else {
                            mediaContainer.innerHTML = `
                                <div class="attachment-file">
                                    <i class="fas fa-circle"></i>
                                    <span>注转  注 (${message.file_name || message.file || '拽抓  爪'})</span>
                                </div>
                            `;
                        }
                    }
                    break;
                    
                case 'contact':
                    mediaContainer.className = 'contact-preview';
                    if (message.contact) {
                        const contact = message.contact;
                        const fullName = `${contact.first_name || ''} ${contact.last_name || ''}`.trim();
                        mediaContainer.innerHTML = `
                            <div class="contact-info">
                                <div class="contact-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="contact-details">
                                    <div class="contact-name">${fullName || '砖 拽砖专'}</div>
                                    ${contact.phone_number ? `<div class="contact-phone">${contact.phone_number}</div>` : ''}
                                </div>
                            </div>
                        `;
                    } else {
                        mediaContainer.innerHTML = `
                            <div class="contact-info">
                                <i class="fas fa-user"></i>
                                <span>砖 拽砖专</span>
                            </div>
                        `;
                    }
                    break;
                    
                case 'location':
                    mediaContainer.className = 'location-preview';
                    if (message.location) {
                        const location = message.location;
                        const mapUrl = `https://www.openstreetmap.org/?mlat=${location.latitude}&mlon=${location.longitude}&zoom=15`;
                        
                        mediaContainer.innerHTML = `
                            <div class="location-box">
                                <i class="fas fa-map-marker-alt"></i>
                                <div class="location-info">
                                    <div>拽:</div>
                                    <div class="location-coordinates">${location.latitude}, ${location.longitude}</div>
                                    <a href="${mapUrl}" target="_blank" class="location-link">驻转 驻</a>
                                </div>
                            </div>
                        `;
                    } else {
                        mediaContainer.innerHTML = `
                            <div class="location-box">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>拽</span>
                            </div>
                        `;
                    }
                    break;
                    
                case 'audio':
                    mediaContainer.className = 'audio-attachment';
                    if (mediaFile) {
                        mediaContainer.innerHTML = `
                            <audio controls>
                                <source src="${mediaFile.data}" type="${mediaFile.type || 'audio/mp3'}">
                                驻驻 砖  转 爪转 
                            </audio>
                        `;
                    } else {
                        mediaContainer.innerHTML = `
                            <div class="attachment-file">
                                <i class="fas fa-music"></i>
                                <span>拽抓  (${message.file_name || message.file || '拽抓  爪'})</span>
                            </div>
                        `;
                    }
                    break;
                    
                case 'animation':
                    mediaContainer.className = 'attachment';
                    if (mediaFile) {
                        if (mediaFile.type && mediaFile.type.includes('image/gif')) {
                            mediaContainer.innerHTML = `
                                <img src="${mediaFile.data}" alt="爪" 
                                     data-path="${encodeURIComponent(mediaFile.path || '')}" 
                                     class="attachment-image">
                            `;
                        } else {
                            mediaContainer.innerHTML = `
                                <video autoplay loop muted width="100%">
                                    <source src="${mediaFile.data}" type="${mediaFile.type || 'video/mp4'}">
                                    驻驻 砖  转 爪转 爪
                                </video>
                            `;
                        }
                    } else {
                        mediaContainer.innerHTML = `
                            <div class="attachment-file">
                                <i class="fas fa-film"></i>
                                <span>爪 (${message.file_name || message.file || '拽抓  爪'})</span>
                            </div>
                        `;
                    }
                    break;
                    
                case 'poll':
                    mediaContainer.className = 'poll-container';
                    let pollOptions = '';
                    
                    if (message.poll && message.poll.options) {
                        message.poll.options.forEach(option => {
                            const percentage = message.poll.total_voters > 0 ? 
                                Math.round((option.voters / message.poll.total_voters) * 100) : 0;
                            
                            pollOptions += `
                                <div class="poll-option">
                                    <div class="poll-option-text">${option.text}</div>
                                    <div class="poll-option-votes">${option.voters} (${percentage}%)</div>
                                    <div class="poll-option-bar">
                                        <div class="poll-option-progress" style="width: ${percentage}%"></div>
                                    </div>
                                </div>
                            `;
                        });
                    }
                    
                    mediaContainer.innerHTML = `
                        <div class="poll-question">${message.poll ? message.poll.question : '住拽专'}</div>
                        ${pollOptions}
                        <div class="poll-total">${message.poll ? `住" 爪注转: ${message.poll.total_voters}` : ''}</div>
                    `;
                    break;
                    
                default:
                    return null;
            }
            
            return mediaContainer;
        }

        // 驻专  拽抓
        function formatFileSize(sizeInBytes) {
            if (!sizeInBytes || isNaN(sizeInBytes)) return '';
            
            const kb = sizeInBytes / 1024;
            if (kb < 1024) {
                return Math.round(kb) + ' KB';
            }
            
            const mb = kb / 1024;
            if (mb < 1024) {
                return mb.toFixed(1) + ' MB';
            }
            
            const gb = mb / 1024;
            return gb.toFixed(2) + ' GB';
        }
        
        // 驻砖 拽抓  专 注 住 注
        function findMediaFile(message) {
            if (!message || !message.mediaType) return null;
            
            // 1. First try direct file path matching if available in the message
            if (message.photo) {
                const photoPath = message.photo;
                for (const [key, value] of mediaStore.entries()) {
                    if (value.path === photoPath || key === getFileNameFromPath(photoPath)) {
                        return value;
                    }
                }
            }
            
            if (message.file) {
                const filePath = message.file;
                for (const [key, value] of mediaStore.entries()) {
                    if (value.path === filePath || key === getFileNameFromPath(filePath)) {
                        return value;
                    }
                }
            }
            
            // 2. Try finding by mediaFileId (if available)
            if (message.mediaFileId) {
                for (const [key, value] of mediaStore.entries()) {
                    if (key === message.mediaFileId || key.includes(message.mediaFileId)) {
                        return value;
                    }
                }
            }
            
            // 3. For specific file types, try pattern matching
            const fileName = message.file_name || '';
            if (fileName) {
                for (const [key, value] of mediaStore.entries()) {
                    if (key === fileName || getFileNameFromPath(value.path) === fileName) {
                        return value;
                    }
                }
            }
            
            // 4. Try file type directory matching
            const mediaDirectories = {
                'photo': ['photos/', 'photo_'],
                'video': ['video_files/', 'videos/', 'video_'],
                'voice': ['voice_messages/', 'voice_'],
                'video_note': ['round_video_messages/', 'round_video_'],
                'sticker': ['stickers/', 'sticker'],
                'animation': ['animations/', 'animation_'],
                'document': ['files/', 'document_']
            };
            
            const filePatterns = mediaDirectories[message.mediaType] || [];
            for (const pattern of filePatterns) {
                for (const [key, value] of mediaStore.entries()) {
                    const path = value.path || key;
                    if (path.includes(pattern)) {
                        if (fileName && path.includes(fileName)) {
                            return value;
                        }
                        
                        // For files with specific formats
                        if (message.mediaType === 'photo' && value.type.includes('image')) {
                            return value;
                        }
                        if (message.mediaType === 'video' && (value.type.includes('video') || path.endsWith('.MOV'))) {
                            return value;
                        }
                        if (message.mediaType === 'voice' && (value.type.includes('audio') || path.endsWith('.ogg'))) {
                            return value;
                        }
                        if (message.mediaType === 'video_note' && path.includes('round_video')) {
                            return value;
                        }
                    }
                }
            }
            
            // 5. Check based on file extension for common formats
            const extensionMap = {
                'photo': ['.jpg', '.jpeg', '.png', '.heic', '.HEIC'],
                'video': ['.mp4', '.mov', '.MOV', '.avi'],
                'voice': ['.ogg', '.mp3', '.wav'],
                'video_note': ['.mp4', '.mov'],
                'sticker': ['.webp', '.tgs'],
                'animation': ['.gif', '.mp4'],
                'document': ['.pdf', '.doc', '.docx', '.txt']
            };
            
            const extensions = extensionMap[message.mediaType] || [];
            for (const ext of extensions) {
                for (const [key, value] of mediaStore.entries()) {
                    const path = value.path || key;
                    if (path.toLowerCase().endsWith(ext.toLowerCase())) {
                        return value;
                    }
                }
            }
            
            // 6. Last resort - just try to match by timestamp if available
            if (message.timestamp) {
                const date = new Date(message.timestamp);
                const formattedDate = date.toISOString().split('T')[0].replace(/-/g, '');
                
                for (const [key, value] of mediaStore.entries()) {
                    const path = value.path || key;
                    if (path.includes(formattedDate)) {
                        // Match media type with file type
                        if ((message.mediaType === 'photo' && value.type.includes('image')) ||
                            (message.mediaType === 'video' && (value.type.includes('video') || path.endsWith('.MOV'))) ||
                            (message.mediaType === 'voice' && (value.type.includes('audio') || path.endsWith('.ogg'))) ||
                            (message.mediaType === 'video_note' && path.includes('round_video'))) {
                            return value;
                        }
                    }
                }

                // 1. 拽 转 注专 转转 注专转 (thumbnails)
                if (message.thumbnail) {
                    for (const [key, value] of mediaStore.entries()) {
                        if (key === message.thumbnail || value.path === message.thumbnail) {
                            return value;
                        }
                    }
                }

                // 2. 拽 转 注专 住拽专 住 TGS
                if (message.mediaType === 'sticker' && message.file_name && message.file_name.endsWith('.tgs')) {
                    // 拽  砖 转 注专转
                    if (message.thumbnail) {
                        for (const [key, value] of mediaStore.entries()) {
                            if (key === message.thumbnail || value.path === message.thumbnail) {
                                return value;
                            }
                        }
                    }
                    
                    //   转 注专转, 驻砖 转 拽抓 -TGS 注爪
                    for (const [key, value] of mediaStore.entries()) {
                        if (key.endsWith('.tgs') || (value.path && value.path.endsWith('.tgs'))) {
                            return value;
                        }
                    }
                }

                // 3. 拽转 住驻爪驻转 拽爪 注转
                const problematicFiles = [
                    "IMG_2435.MOV",  // 住专 专砖
                    "AnimatedSticker.tgs",  // 住拽专 驻砖
                    "IMG_6855.HEIC"  // 转转 HEIC
                ];

                if (message.file_name && problematicFiles.includes(message.file_name)) {
                    // 驻砖 拽 驻 砖 拽抓
                    for (const [key, value] of mediaStore.entries()) {
                        if (key === message.file_name || 
                            (value.name && value.name === message.file_name) ||
                            (value.path && value.path.includes(message.file_name))) {
                            return value;
                        }
                    }
                    
                    // 驻砖 驻 转 
                    if (message.file) {
                        for (const [key, value] of mediaStore.entries()) {
                            if (key === message.file || value.path === message.file) {
                                return value;
                            }
                        }
                    }
                }

                // 4. 砖专 专 拽抓 , 住 拽  转 住转 砖转
                if (message.mediaType === 'video' && message.file_name) {
                    const fileNameLower = message.file_name.toLowerCase();
                    if (fileNameLower.endsWith('.mov')) {
                        for (const [key, value] of mediaStore.entries()) {
                            const keyLower = key.toLowerCase();
                            const pathLower = value.path ? value.path.toLowerCase() : '';
                            
                            if (keyLower.endsWith('.mov') || pathLower.endsWith('.mov')) {
                                return value;
                            }
                        }
                    }
                }
            }
            
            return null;
        }

        // 驻拽爪 拽转 拽 转 住 拽抓
        function getFileIcon(fileTypeOrName) {
            const lowerType = typeof fileTypeOrName === 'string' ? fileTypeOrName.toLowerCase() : '';
            
            if (lowerType.includes('image') || lowerType.endsWith('.jpg') || lowerType.endsWith('.png') || lowerType.endsWith('.jpeg')) {
                return 'fas fa-file-image';
            } else if (lowerType.includes('video') || lowerType.endsWith('.mp4') || lowerType.endsWith('.mov')) {
                return 'fas fa-file-video';
            } else if (lowerType.includes('audio') || lowerType.endsWith('.mp3') || lowerType.endsWith('.opus') || lowerType.endsWith('.ogg')) {
                return 'fas fa-file-audio';
            } else if (lowerType.includes('pdf') || lowerType.endsWith('.pdf')) {
                return 'fas fa-file-pdf';
            } else if (lowerType.includes('word') || lowerType.endsWith('.doc') || lowerType.endsWith('.docx')) {
                return 'fas fa-file-word';
            } else if (lowerType.includes('excel') || lowerType.endsWith('.xls') || lowerType.endsWith('.xlsx')) {
                return 'fas fa-file-excel';
            } else if (lowerType.includes('zip') || lowerType.endsWith('.zip') || lowerType.endsWith('.tgz') || lowerType.endsWith('.rar')) {
                return 'fas fa-file-archive';
            } else if (lowerType.endsWith('.txt')) {
                return 'fas fa-file-alt';
            } else {
                return 'fas fa-file';
            }
        }

        // ===================================================
        // =================== 驻拽爪转 注专 ==================
        // ===================================================

        //  专注 转转
        function setupImageEventListeners() {
            // 住专  拽  
            const oldImages = document.querySelectorAll('.attachment-image');
            oldImages.forEach(img => {
                img.removeEventListener('click', imageClickHandler);
            });
            
            // 住祝  拽拽  转转 住
            document.addEventListener('click', imageClickHandler);
        }

        // 驻 专注 爪 注 转
        function imageClickHandler(e) {
            const target = e.target;
            
            // 拽  拽拽  注 转转 爪专祝
            if (target.classList.contains('attachment-image')) {
                e.preventDefault();
                
                // 拽 转 转 驻 data
                const path = target.getAttribute('data-path') ? decodeURIComponent(target.getAttribute('data-path')) : '';
                
                // 爪 转 转 
                showImageInModal(target.src, path);
            }
        }

        // 爪转 转 
        function showImageInModal(imageUrl, path) {
            const modal = document.getElementById('image-modal');
            const modalImg = document.getElementById('modal-image');
            
            //  砖-URL 转拽
            if (!imageUrl) {
                console.error(' URL 转拽 转');
                return;
            }
            
            modalImg.src = imageUrl;
            modal.style.display = 'flex';
        }

        // 住专转  转
        function closeModal() {
            document.getElementById('image-modal').style.display = 'none';
        }

        // 拽 
        function clearAll() {
            chatData = {
                name: '',
                type: '',
                messages: [],
                about: ''
            };
            
            mediaStore.clear();
            participants.clear();
            
            document.getElementById('chat-container').innerHTML = `
                <div class="no-chat">
                    <i class="fas fa-paper-plane"></i>
                    <p> 砖 爪</p>
                    <p>注 拽抓 ZIP 砖 砖转 专  转</p>
                </div>
            `;
            
            // 拽 砖转 拽抓
            document.getElementById('json-file').value = '';
            document.getElementById('zip-file').value = '';
            
            showStatusMessage('转 拽 爪', 'success');
        }

        // 爪转  注
        function showLoader(message) {
            const loader = document.getElementById('loader');
            document.getElementById('loader-text').textContent = message || '注...';
            loader.style.display = 'flex';
        }

        // 注 拽住  注
        function updateLoaderText(message) {
            document.getElementById('loader-text').textContent = message;
        }

        // 住转专转  注
        function hideLoader() {
            document.getElementById('loader').style.display = 'none';
        }

        // 爪转 注转 住住
        function showStatusMessage(message, type = 'info') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = type;
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 3000);
        }

        // ===================================================
        // =================== 爪 砖 ====================
        // ===================================================

        // 驻拽爪 转 爪 砖 -HTML
        function exportChat(format) {
            if (chatData.messages.length === 0) {
                showStatusMessage(' 砖 爪. 注 拽抓 砖 转', 'error');
                return;
            }
            
            exportToHtml();
        }

        // 驻拽爪 专转 data URLs -URLs  转专
        function createSafeMediaUrl(mediaData, mediaType) {
            try {
                // 专 data URL 
                if (mediaData.startsWith('data:')) {
                    // 抓 转 转 专 -data URL
                    const base64Data = mediaData.split(',')[1];
                    const binaryData = atob(base64Data);
                    
                    // 专 
                    const uint8Array = new Uint8Array(binaryData.length);
                    for (let i = 0; i < binaryData.length; i++) {
                        uint8Array[i] = binaryData.charCodeAt(i);
                    }
                    
                    const blob = new Blob([uint8Array], { type: mediaType });
                    return URL.createObjectURL(blob);
                }
                
                // 专 转 -URL 拽专    data URL
                return mediaData;
            } catch (error) {
                console.error('砖 爪专转 URL  :', error);
                return mediaData; // 专 转 -URL 拽专 拽专 砖 砖
            }
        }

        // 爪 -HTML
        function exportToHtml() {
            showLoader('爪 -HTML...');
            
            // 爪专转 HTML 住专  专转 转转
            const element = document.getElementById('chat-container');
            const style = document.querySelector('style').innerHTML;
            
            // 专 转 转转  URLs 注转 爪 HTML
            const tempContainer = element.cloneNode(true);
            
            // 驻 转转 爪专驻转
            const images = tempContainer.querySelectorAll('.attachment img, .sticker img');
            images.forEach(img => {
                if (img.hasAttribute('data-path')) {
                    const path = decodeURIComponent(img.getAttribute('data-path'));
                    img.removeAttribute('data-path');
                    img.setAttribute('onclick', 'openImageModal(this.src)');
                }
            });
            
            // 驻  砖 
            const videos = tempContainer.querySelectorAll('video');
            videos.forEach(video => {
                const source = video.querySelector('source');
                if (source && source.src.startsWith('data:')) {
                    const mediaType = source.type || 'video/mp4';
                    source.src = createSafeMediaUrl(source.src, mediaType);
                }
            });
            
            // 驻  砖 
            const audios = tempContainer.querySelectorAll('audio');
            audios.forEach(audio => {
                const source = audio.querySelector('source');
                if (source && source.src.startsWith('data:')) {
                    const mediaType = source.type || 'audio/ogg';
                    source.src = createSafeMediaUrl(source.src, mediaType);
                }
            });
            
            // 驻 转转 驻专驻
            const profileImage = tempContainer.querySelector('.avatar img');
            if (profileImage && appSettings.profileImage) {
                profileImage.src = appSettings.profileImage;
            }
            
            // 驻 转转 专拽注
            const chatBody = tempContainer.querySelector('.chat-body');
            if (chatBody && appSettings.backgroundImage) {
                // 住祝 住 砖专转  ( CSS)
                chatBody.style.backgroundImage = `url(${appSettings.backgroundImage})`;
            }
            
            // 住祝 转  拽爪  住 拽 拽抓 HTML
            let mediaAssetsScript = '';
            let mediaCounter = 0;
            
            for (const [filename, mediaFile] of mediaStore.entries()) {
                mediaCounter++;
                mediaAssetsScript += `
                    mediaStore.set('${filename.replace(/'/g, "\\'")}', {
                        data: '${mediaFile.data.replace(/'/g, "\\'")}',
                        type: '${mediaFile.type}',
                        name: '${filename.replace(/'/g, "\\'")}',
                        path: '${(mediaFile.path || '').replace(/'/g, "\\'")}'
                    });
                `;
                
                //  转  住拽专驻
                if (mediaCounter % 50 === 0) {
                    mediaAssetsScript += `
                        console.log('注转 : ${mediaCounter} 拽爪');
                    `;
                }
            }
            
            // 住祝 注 注 砖转转驻
            let participantsScript = '';
            for (const [id, participant] of participants.entries()) {
                participantsScript += `
                    participants.set('${id}', {
                        id: '${id}',
                        name: '${participant.name.replace(/'/g, "\\'")}',
                        username: '${participant.username || ''}',
                        color: '${participant.color}'
                        ${participant.avatar ? `, avatar: '${participant.avatar.replace(/'/g, "\\'")}'` : ''}
                    });
                `;
            }
            
            // 住祝 专拽 转 注 注 转转 驻专驻 专拽注  拽
            let settingsScript = '';
            if (appSettings.profileImage) {
                settingsScript += `
                    appSettings.profileImage = '${appSettings.profileImage.replace(/'/g, "\\'")}';
                `;
            }
            if (appSettings.backgroundImage) {
                settingsScript += `
                    appSettings.backgroundImage = '${appSettings.backgroundImage.replace(/'/g, "\\'")}';
                `;
            }
            
            const htmlTemplate = `<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Chat - ${chatData.name}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>${style}</style>
</head>
<body style="background-color: #f0f2f5; margin: 0; padding: 20px;">
    <div class="container" style="display: flex; justify-content: center;">
        ${tempContainer.outerHTML}
    </div>
    
    <div id="image-modal" class="modal">
        <span class="modal-close">&times;</span>
        <img class="modal-content" id="modal-image">
    </div>

    <script>
    // 专  爪转 转转 
    const mediaStore = new Map();
    ${mediaAssetsScript}
    
    // 注 注 砖转转驻
    const participants = new Map();
    ${participantsScript}
    
    // 专转 专
    const appSettings = {
        profileImage: null,
        backgroundImage: null
    };
    ${settingsScript}
    
    // 驻转转 转 
    function openImageModal(src) {
        const modal = document.getElementById('image-modal');
        const modalImg = document.getElementById('modal-image');
        modalImg.src = src;
        modal.style.display = 'flex';
    }
    
    // 住专转 
    function closeModal() {
        document.getElementById('image-modal').style.display = 'none';
    }
    
    //  专注
    document.querySelector('.modal-close').addEventListener('click', closeModal);
    
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeModal();
        }
    });

    // 住祝  专注  转转
    document.querySelectorAll('.attachment img, .sticker img').forEach(img => {
        img.addEventListener('click', function() {
            openImageModal(this.src);
        });
    });
</body>
</html>`;
            
            // 爪专转 拽 专
            try {
                const blob = new Blob([htmlTemplate], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `telegram-chat-${chatData.name.replace(/[^\w\s]/gi, '')}-${new Date().toISOString().slice(0, 10)}.html`;
                document.body.appendChild(a);
                a.click();
                
                // 拽
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    hideLoader();
                    showStatusMessage('砖 爪 -HTML 爪', 'success');
                }, 100);
            } catch (error) {
                console.error('Error exporting to HTML:', error);
                hideLoader();
                showStatusMessage('砖 爪 -HTML', 'error');
            }
        }

        // 驻拽爪 转 砖拽 注转 住驻专转
        function initializeChatViewer() {
            // 注 住驻专转 爪转  专砖
            loadExternalLibraries();
            
            // 住祝 专注 拽 拽砖专 驻 住专转 
            window.addEventListener('beforeunload', function() {
                cleanupDownloadLinks();
            });
            
            // 专注 转 专 砖
            if (chatData && chatData.messages && chatData.messages.length > 0) {
                updateChatView();
            }
            
            console.log('爪 砖转 专 转 爪');
        }

        // 驻注 转 转 砖祝 注
        document.addEventListener('DOMContentLoaded', function() {
            initializeChatViewer();
        });

        // 住祝 驻拽爪转 专  专爪 专 注转 砖
        function onChatLoaded() {
            // 拽 拽砖专 专 拽
            cleanupDownloadLinks();
            
            // 拽  砖 注转 砖专砖转 驻 
            if (chatData && chatData.messages) {
                const problematicMessages = chatData.messages.filter(msg => 
                    (msg.mediaType === 'sticker' && msg.is_animated_sticker) ||
                    (msg.mediaType === 'video' && msg.file_name && msg.file_name.toLowerCase().endsWith('.mov')) ||
                    (msg.mediaType === 'document')
                );
                
                if (problematicMessages.length > 0) {
                    console.log(`爪 ${problematicMessages.length} 注转 砖专砖转 驻 `);
                }
            }
        }
</script>
</body>
</html>
